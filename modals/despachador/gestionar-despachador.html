<!-- MODAL GESTIONAR SOLICITUD - DESPACHADOR -->
<div class="modal fade" id="modalGestionarSolicitudDesp" tabindex="-1" role="dialog" aria-labelledby="modalGestionarSolicitudDespLabel" aria-hidden="true" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalGestionarSolicitudDespLabel">
                    <i class="fas fa-tasks mr-2"></i>Gestionar Solicitud - Despachador
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation Principal -->
                <ul class="nav nav-tabs nav-justified mb-4" id="gestionarDespMainTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="gestionarDesp-solicitud-tab" data-toggle="tab" href="#gestionarDesp-solicitud" role="tab" aria-controls="gestionarDesp-solicitud" aria-selected="true">
                            <i class="fas fa-file-alt mr-2"></i>Detalle de Solicitud
                        </a>
                    </li>
                    <li class="nav-item" id="gestionarDesp-aprobadores-tab-li" style="display: none;">
                        <a class="nav-link" id="gestionarDesp-aprobadores-tab" data-toggle="tab" href="#gestionarDesp-aprobadores" role="tab" aria-controls="gestionarDesp-aprobadores" aria-selected="false">
                            <i class="fas fa-user-check mr-2"></i>Aprobadores
                        </a>
                    </li>
                    <li class="nav-item" id="gestionarDesp-distribucion-tab-li" style="display: none;">
                        <a class="nav-link" id="gestionarDesp-distribucion-tab" data-toggle="tab" href="#gestionarDesp-distribucion" role="tab" aria-controls="gestionarDesp-distribucion" aria-selected="false">
                            <i class="fas fa-share-alt mr-2"></i>Lista de Distribución
                        </a>
                    </li>
                </ul>

                <!-- Tabs Content Principal -->
                <div class="tab-content" id="gestionarDespMainTabsContent">
                    <!-- Tab: Detalle de Solicitud -->
                    <div class="tab-pane fade show active" id="gestionarDesp-solicitud" role="tabpanel" aria-labelledby="gestionarDesp-solicitud-tab">
                        <div class="alert alert-info mb-3" role="alert">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Leyenda:</strong>
                    <span class="ml-3"><span class="text-danger">*</span> Campos obligatorios</span>
                    <span class="ml-3"><span class="badge badge-warning">EDITABLE</span> Campos que pueden modificarse</span>
                </div>
                
                <!-- Header: Estado y Observaciones -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-info-circle mr-2"></i>Estado y Observaciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="alert mb-0 d-flex align-items-center" role="alert" id="gestionarDespEstadoAlert">
                                    <i class="fas fa-circle mr-2"></i>
                                    <div>
                                        <strong>Estado:</strong> <span class="badge ml-2" id="gestionarDespEstadoBadge">-</span>
                                        <small class="d-block mt-1 text-muted" id="gestionarDespEstadoDescripcion">-</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1"><strong>Observaciones:</strong></label>
                                    <p class="mb-0" id="gestionarDespObservacionesHeader">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Identificación (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="fas fa-edit mr-2"></i>Identificación <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">ID <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="gestionarDespIDSolicitud" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo de Trabajo<span class="text-danger">*</span></label>
                                    <select class="form-control" id="gestionarDespTipo" required>
                                        <option value="">Seleccione...</option>
                                        <option value="SDCN">SDCN - Solicitud de Desconexión Curso Normal</option>
                                        <option value="SDCF">SDCF - Solicitud de Desconexión Curso Forzoso</option>
                                        <option value="SICN">SICN - Solicitud de Intervención Curso Normal</option>
                                        <option value="SICF">SICF - Solicitud de Intervención Curso Forzoso</option>
                                        <option value="IL">IL - Informe de Limitación</option>
                                        <option value="MM">MM - Mantención Mayor</option>
                                        <option value="SODI">SODI - Solicitud de Desconexión/Intervención</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Relación SODI/CEN</label>
                                    <textarea class="form-control" id="gestionarDespRelacionSODICEN" rows="2" placeholder="Ej: CEN-2025-001, SODI-123"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Fechas Programadas (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="far fa-calendar-alt mr-2"></i>Fechas Programadas <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Inicio Programado</label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespInicioProgramado">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Fin Programado</label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespFinProgramado">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Fechas Efectivas (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="far fa-calendar-check mr-2"></i>Fechas Efectivas de Ejecución <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Inicio Efectivo <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespInicioEfectivo" required>
                                    <small class="form-text text-muted">Obligatorio. Al completar, cambia a "Vigente"</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Fin Efectivo</label>
                                    <input type="datetime-local" class="form-control" id="gestionarDespFinEfectivo">
                                    <small class="form-text text-muted">Obligatorio para Finalizar. Opcional para Suspender/Rechazar</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Empresas Involucradas (EDITABLE) -->
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="fas fa-edit mr-2"></i>Empresas Involucradas <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Empresa Solicitante <span class="text-danger">*</span></label>
                                    <select class="form-control" id="gestionarDespEmpresaSolicitante" required>
                                        <option value="">Seleccione...</option>
                                        <option value="CDC">CDC</option>
                                        <option value="GM">GM</option>
                                        <option value="Transelec Norte">Transelec Norte</option>
                                        <option value="Transelec Sur">Transelec Sur</option>
                                        <option value="Chilquinta">Chilquinta</option>
                                        <option value="Saesa">Saesa</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Empresa Receptora <span class="text-danger">*</span></label>
                                    <select class="form-control" id="gestionarDespEmpresaReceptora" required>
                                        <option value="">Seleccione...</option>
                                        <option value="CDC">CDC</option>
                                        <option value="GM">GM</option>
                                        <option value="Transelec Norte">Transelec Norte</option>
                                        <option value="Transelec Sur">Transelec Sur</option>
                                        <option value="Chilquinta">Chilquinta</option>
                                        <option value="Saesa">Saesa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Instalación y Equipos -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-building mr-2"></i>Instalación y Equipos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Instalación GM</label>
                                    <select class="form-control" id="gestionarDespInstalacionGM" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Santiago Solar">Santiago Solar</option>
                                        <option value="Nueva Renca">Nueva Renca</option>
                                        <option value="Los Vientos">Los Vientos</option>
                                        <option value="Santa Lidia">Santa Lidia</option>
                                        <option value="CEME1">CEME1</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Instalaciones/equipos a intervenir</label>
                                    <select class="form-control" id="gestionarDespEquipos" multiple readonly size="4">
                                        <option value="">No hay equipos seleccionados</option>
                                    </select>
                                    <small class="form-text text-muted">Campo de solo lectura</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Características de la Intervención (SOLO LECTURA) -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-cogs mr-2"></i>Características de la Intervención</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo de Intervención</label>
                                    <select class="form-control" id="gestionarDespTipoIntervencion" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Intervención">Intervención</option>
                                        <option value="Desconexión">Desconexión</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Potencia (MWH)</label>
                                    <input type="text" class="form-control" id="gestionarDespPotencia" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Aplica SODI</label>
                                    <select class="form-control" id="gestionarDespAplicaSODI" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Clasificación del Riesgo</label>
                                    <select class="form-control" id="gestionarDespRiesgo" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="Bajo">Bajo</option>
                                        <option value="Medio">Medio</option>
                                        <option value="Alto">Alto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2" id="gestionarDespDescripcionRiesgoContainer">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción del Riesgo del Trabajo</label>
                                    <textarea class="form-control" id="gestionarDespDescripcionRiesgo" rows="2" readonly></textarea>
                                    <small class="form-text text-muted">Descripción del riesgo para cualquier nivel de clasificación</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Descripción y Condiciones (SOLO LECTURA) -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>Descripción y Condiciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Descripción del trabajo</label>
                                    <textarea class="form-control" id="gestionarDespDescripcion" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Condiciones requeridas</label>
                                    <textarea class="form-control" id="gestionarDespCondiciones" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Comentarios</label>
                                    <textarea class="form-control" id="gestionarDespComentariosActuales" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Afectaciones</label>
                                    <select class="form-control" id="gestionarDespAfectaciones" disabled>
                                        <option value="">Seleccione...</option>
                                        <option value="SSCC">SSCC</option>
                                        <option value="Protecciones">Protecciones</option>
                                        <option value="Medidores">Medidores</option>
                                        <option value="SSCC, Protecciones">SSCC, Protecciones</option>
                                        <option value="SSCC, Medidores">SSCC, Medidores</option>
                                        <option value="Protecciones, Medidores">Protecciones, Medidores</option>
                                        <option value="SSCC, Protecciones, Medidores">SSCC, Protecciones, Medidores</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6" id="gestionarDespDescripcionAfectacionContainer" style="display: none;">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción de la Afectación</label>
                                    <textarea class="form-control" id="gestionarDespDescripcionAfectacion" rows="2" readonly></textarea>
                                    <small class="form-text text-muted">Se muestra solo si hay afectaciones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Archivo Adjunto (SOLO LECTURA) -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-paperclip mr-2"></i>Archivo Adjunto</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <span id="gestionarDespAdjunto" class="text-muted">-</span>
                                    <button type="button" class="btn btn-sm btn-primary ml-2" id="gestionarDespDescargarAdjunto" style="display:none;">
                                        <i class="fas fa-download mr-1"></i>Descargar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Gestión -->
                <div class="card mb-3 border-success">
                    <div class="card-header bg-success text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-tasks mr-2"></i>Gestión de la Solicitud</h6>
                    </div>
                    <div class="card-body">
                        <!-- Observaciones actuales -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info" role="alert">
                                    <strong><i class="fas fa-info-circle mr-2"></i>Observaciones Actuales:</strong>
                                    <p class="mb-0 mt-2" id="gestionarDespObservacionesActuales">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Nuevas observaciones -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="font-weight-bold">Nuevas Observaciones <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="gestionarDespComentarios" rows="3" placeholder="Ingrese las observaciones sobre la gestión..." required></textarea>
                                    <small class="form-text text-muted"><i class="fas fa-exclamation-circle mr-1"></i>Estas observaciones se agregarán al historial</small>
                                </div>
                            </div>
                        </div>

                        <!-- Acciones disponibles según el estado -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Acción a realizar <span class="text-danger">*</span></label>
                                    <div id="gestionarDespAccionesContainer">
                                        <!-- Las acciones se cargarán dinámicamente según el estado -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metadata del Sistema -->
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-info-circle mr-2"></i>Información del Sistema
                        </h6>
                    </div>
                </div>
                <div class="row bg-light p-3 rounded">
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>ID</strong></label>
                            <p class="mb-0" id="gestionarDespIDRegistro">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Creado</strong></label>
                            <p class="mb-0" id="gestionarDespCreado">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Actualizado</strong></label>
                            <p class="mb-0" id="gestionarDespActualizado">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Administrador</strong></label>
                            <p class="mb-0" id="gestionarDespAdministrador">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Solicitante</strong></label>
                            <p class="mb-0" id="gestionarDespSolicitante">-</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group mb-0">
                            <label class="text-muted small"><strong>Creado Por</strong></label>
                            <p class="mb-0" id="gestionarDespCreadoPor">-</p>
                        </div>
                    </div>
                </div>                    </div>
                    <!-- Fin Tab: Detalle de Solicitud -->

                    <!-- Tab: Aprobadores -->
                    <div class="tab-pane fade" id="gestionarDesp-aprobadores" role="tabpanel" aria-labelledby="gestionarDesp-aprobadores-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Aprobadores:</strong> Personas que deben aprobar esta solicitud.
                        </div>

                        <div class="card">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-user-check mr-2"></i>Aprobadores Asignados</h6>
                            </div>
                            <div class="card-body">
                                <div id="gestionarDesp-listaAprobadores" class="border rounded p-3" style="min-height: 200px;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <p>No hay aprobadores asignados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Aprobadores -->

                    <!-- Tab: Lista de Distribución -->
                    <div class="tab-pane fade" id="gestionarDesp-distribucion" role="tabpanel" aria-labelledby="gestionarDesp-distribucion-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Distribución:</strong> Personas que reciben notificaciones sobre esta solicitud.
                        </div>

                        <div class="card">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-share-alt mr-2"></i>Lista de Distribución</h6>
                            </div>
                            <div class="card-body">
                                <div id="gestionarDesp-listaDistribucion" class="border rounded p-3" style="min-height: 200px;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-envelope fa-2x mb-2"></i>
                                        <p>No hay usuarios en la lista de distribución</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Lista de Distribución -->
                </div>
                <!-- Fin Tabs Content Principal -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmarGestionSolicitudDespachador()">
                    <i class="fas fa-check mr-2"></i>Confirmar Gestión
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para gestión de transiciones de estado -->
<!-- COMENTADO: Funcionalidad movida a despachador-modals.js -->
<!--
<script>
// Variables globales para el modal de gestión
let estadoActualSolicitud = '';
let transicionSeleccionada = '';

$(document).ready(function() {
    // Inicializar eventos del modal
    $('#modalGestionarSolicitudDesp').on('shown.bs.modal', function() {
        cargarAccionesDisponibles();
        configurarValidacionesFecha();
        
        // Debug: mostrar estado detectado en consola
        console.log('Estado actual detectado:', estadoActualSolicitud);
    });
    
    // Evento para cambios en las acciones
    $(document).on('change', 'input[name="accionGestion"]', function() {
        transicionSeleccionada = $(this).val();
        manejarCambioAccion(transicionSeleccionada);
    });
    
    // Validación en tiempo real de fecha efectiva de finalización
    $('#gestionarDespFinEfectivo').on('change', function() {
        validarFechaFinalizacion();
    });
});

// Cargar acciones disponibles según el estado actual
function cargarAccionesDisponibles() {
    const container = $('#gestionarDespAccionesContainer');
    container.empty();
    
    // Obtener el estado actual (esto se debería cargar desde los datos de la solicitud)
    estadoActualSolicitud = obtenerEstadoActual();
    
    // Debug: mostrar información detallada
    console.log('=== DEBUG ACCIONES ===');
    console.log('Estado detectado:', estadoActualSolicitud);
    console.log('Tipo de estado:', typeof estadoActualSolicitud);
    console.log('Longitud del estado:', estadoActualSolicitud.length);
    
    let acciones = [];
    
    switch(estadoActualSolicitud) {
        case 'Despachador Gestionando':
            acciones = [
                {valor: 'programar', texto: 'Programar Solicitud', destino: 'Programada'},
                {valor: 'anular', texto: 'Anular Solicitud', destino: 'Anulada'}
            ];
            break;
            
        case 'Programada':
            acciones = [
                {valor: 'iniciar', texto: 'Iniciar Trabajo', destino: 'Vigente', requiereFecha: 'inicio'},
                {valor: 'rechazar', texto: 'Rechazar Trabajo', destino: 'Rechazada'}
            ];
            break;
            
        case 'Vigente':
            acciones = [
                {valor: 'extender', texto: 'Extender Trabajo', destino: 'Extendida'},
                {valor: 'suspender', texto: 'Suspender Trabajo', destino: 'Suspendida'},
                {valor: 'finalizar', texto: 'Finalizar Trabajo', destino: 'Finalizada', requiereFecha: 'fin'},
                {valor: 'devolver_programada', texto: 'Devolver a Programada', destino: 'Programada', mensaje: 'Se borrará la fecha efectiva de inicio'}
            ];
            break;
            
        case 'Extendida':
            acciones = [
                {valor: 'finalizar', texto: 'Finalizar Trabajo', destino: 'Finalizada', requiereFecha: 'fin', obligatorio: true},
                {valor: 'devolver_vigente', texto: 'Devolver a Vigente', destino: 'Vigente'}
            ];
            break;
            
        case 'Suspendida':
            acciones = [
                {valor: 'finalizar', texto: 'Finalizar Trabajo', destino: 'Finalizada', requiereFecha: 'fin', obligatorio: true},
                {valor: 'devolver_vigente', texto: 'Devolver a Vigente', destino: 'Vigente'}
            ];
            break;
            
        case 'Finalizada':
            acciones = [
                {valor: 'devolver_extendida', texto: 'Devolver a Extendida', destino: 'Extendida', mensaje: 'La fecha efectiva de finalización se borrará'},
                {valor: 'devolver_suspendida', texto: 'Devolver a Suspendida', destino: 'Suspendida', mensaje: 'La fecha efectiva de finalización se borrará'},
                {valor: 'devolver_vigente_final', texto: 'Devolver a Vigente', destino: 'Vigente', mensaje: 'La fecha efectiva de finalización se borrará'}
            ];
            break;
            
        default:
            console.log('Estado no reconocido:', estadoActualSolicitud);
            container.html('<div class="alert alert-warning">No hay acciones disponibles para este estado.</div>');
            return;
    }
    
    // Debug: mostrar acciones generadas
    console.log('Acciones generadas:', acciones);
    console.log('Cantidad de acciones:', acciones.length);
    
    // Generar los radio buttons para las acciones
    acciones.forEach(accion => {
        const radioHtml = `
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="accionGestion" id="accion_${accion.valor}" value="${accion.valor}" data-destino="${accion.destino}" data-requiere-fecha="${accion.requiereFecha || ''}" data-obligatorio="${accion.obligatorio || false}" data-mensaje="${accion.mensaje || ''}">
                <label class="form-check-label" for="accion_${accion.valor}">
                    <strong>${accion.texto}</strong>
                    <small class="text-muted d-block">Cambiar a: ${accion.destino}</small>
                    ${accion.mensaje ? `<small class="text-warning d-block"><i class="fas fa-exclamation-triangle mr-1"></i>${accion.mensaje}</small>` : ''}
                </label>
            </div>
        `;
        container.append(radioHtml);
    });
}

// Manejar cambio de acción seleccionada
function manejarCambioAccion(accion) {
    const radioSeleccionado = $(`input[name="accionGestion"]:checked`);
    const requiereFecha = radioSeleccionado.data('requiere-fecha');
    const esObligatorio = radioSeleccionado.data('obligatorio');
    const mensaje = radioSeleccionado.data('mensaje');
    
    // Resetear validaciones previas
    $('#gestionarDespInicioEfectivo').prop('required', false);
    $('#gestionarDespFinEfectivo').prop('required', false);
    $('.fecha-advertencia').remove();
    
    // Configurar validaciones según la acción
    if (requiereFecha === 'inicio') {
        $('#gestionarDespInicioEfectivo').prop('required', true);
        mostrarAdvertenciaFecha('inicio', 'Debe ingresar la fecha efectiva de inicio para esta acción.');
    }
    
    if (requiereFecha === 'fin') {
        $('#gestionarDespFinEfectivo').prop('required', true);
        if (esObligatorio) {
            mostrarAdvertenciaFecha('fin', 'La fecha efectiva de finalización es OBLIGATORIA para esta acción.');
        } else {
            mostrarAdvertenciaFecha('fin', 'Debe ingresar la fecha efectiva de finalización para esta acción.');
        }
    }
    
    // Mostrar mensaje de advertencia si existe
    if (mensaje) {
        mostrarMensajeAdvertencia(mensaje);
    }
}

// Mostrar advertencia para campos de fecha
function mostrarAdvertenciaFecha(tipo, mensaje) {
    const campo = tipo === 'inicio' ? '#gestionarDespInicioEfectivo' : '#gestionarDespFinEfectivo';
    const advertencia = `<small class="form-text text-warning fecha-advertencia"><i class="fas fa-exclamation-triangle mr-1"></i>${mensaje}</small>`;
    $(campo).after(advertencia);
}

// Mostrar mensaje de advertencia general
function mostrarMensajeAdvertencia(mensaje) {
    const advertenciaHtml = `
        <div class="alert alert-warning mt-2 fecha-advertencia" role="alert">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Advertencia:</strong> ${mensaje}
        </div>
    `;
    $('#gestionarDespAccionesContainer').after(advertenciaHtml);
}

// Configurar validaciones específicas para fechas según el estado
function configurarValidacionesFecha() {
    // Si el estado es Extendida o Suspendida, la fecha de finalización debe ser obligatoria
    if (estadoActualSolicitud === 'Extendida' || estadoActualSolicitud === 'Suspendida') {
        $('#gestionarDespFinEfectivo').prop('required', true);
        
        // Agregar indicador visual
        const label = $('label[for="gestionarDespFinEfectivo"]');
        if (!label.find('.text-danger').length) {
            label.html(label.html().replace('Fin Efectivo', 'Fin Efectivo <span class="text-danger">*</span>'));
        }
        
        // Actualizar el texto de ayuda
        $('#gestionarDespFinEfectivo').siblings('.form-text').text('OBLIGATORIO para estados Extendida y Suspendida');
    }
}

// Validar fecha de finalización
function validarFechaFinalizacion() {
    const fechaFin = $('#gestionarDespFinEfectivo').val();
    const radioSeleccionado = $('input[name="accionGestion"]:checked');
    
    if (radioSeleccionado.length > 0) {
        const requiereFecha = radioSeleccionado.data('requiere-fecha');
        const esObligatorio = radioSeleccionado.data('obligatorio');
        
        if (requiereFecha === 'fin' && esObligatorio && !fechaFin) {
            $('#gestionarDespFinEfectivo').addClass('is-invalid');
            if (!$('#gestionarDespFinEfectivo').siblings('.invalid-feedback').length) {
                $('#gestionarDespFinEfectivo').after('<div class="invalid-feedback">La fecha efectiva de finalización es obligatoria.</div>');
            }
        } else {
            $('#gestionarDespFinEfectivo').removeClass('is-invalid');
            $('#gestionarDespFinEfectivo').siblings('.invalid-feedback').remove();
        }
    }
}

// Obtener el estado actual de la solicitud (simulado - en producción vendría de los datos)
function obtenerEstadoActual() {
    // TEMPORAL: Forzar estado "Vigente" para testing
    // Comentar esta línea cuando se integre con datos reales
    return 'Vigente';
    
    // Esta función debería obtener el estado real de la solicitud
    // Intentar obtener desde el badge de estado
    const estadoBadge = $('#gestionarDespEstadoBadge').text().trim();
    
    // Si no hay badge o está vacío, usar estado por defecto para testing
    if (!estadoBadge || estadoBadge === '-' || estadoBadge === '') {
        return 'Vigente'; // Estado por defecto para testing
    }
    
    // Limpiar el texto del badge (puede tener espacios extra o caracteres especiales)
    return estadoBadge.replace(/[^\w\s]/g, '').trim();
}

// Función para confirmar la gestión (actualizada)
function confirmarGestionSolicitudDespachador() {
    const radioSeleccionado = $('input[name="accionGestion"]:checked');
    const observaciones = $('#gestionarDespComentarios').val().trim();
    
    // Validaciones básicas
    if (!radioSeleccionado.length) {
        alert('Debe seleccionar una acción a realizar.');
        return;
    }
    
    if (!observaciones) {
        alert('Debe ingresar observaciones sobre la gestión.');
        return;
    }
    
    // Validaciones específicas de fecha
    const requiereFecha = radioSeleccionado.data('requiere-fecha');
    const esObligatorio = radioSeleccionado.data('obligatorio');
    
    if (requiereFecha === 'inicio') {
        const fechaInicio = $('#gestionarDespInicioEfectivo').val();
        if (!fechaInicio) {
            alert('Debe ingresar la fecha efectiva de inicio para esta acción.');
            return;
        }
    }
    
    if (requiereFecha === 'fin') {
        const fechaFin = $('#gestionarDespFinEfectivo').val();
        if (!fechaFin && (esObligatorio || estadoActualSolicitud === 'Extendida' || estadoActualSolicitud === 'Suspendida')) {
            alert('Debe ingresar la fecha efectiva de finalización para esta acción.');
            return;
        }
    }
    
    // Confirmación adicional para acciones que borran fechas
    const mensaje = radioSeleccionado.data('mensaje');
    if (mensaje && mensaje.includes('borrará')) {
        if (!confirm(`¿Está seguro de continuar? ${mensaje}`)) {
            return;
        }
    }
    
    // Si llegamos aquí, proceder con la gestión
    const accion = radioSeleccionado.val();
    const destino = radioSeleccionado.data('destino');
    
    console.log('Procesando gestión:', {
        accion: accion,
        estadoDestino: destino,
        observaciones: observaciones,
        fechaInicio: $('#gestionarDespInicioEfectivo').val(),
        fechaFin: $('#gestionarDespFinEfectivo').val()
    });
    
    // Aquí iría la lógica para enviar los datos al servidor
    alert(`Gestión confirmada: ${radioSeleccionado.next('label').find('strong').text()}`);
    
    // Cerrar modal
    $('#modalGestionarSolicitudDesp').modal('hide');
}
</script>
-->
