<!-- MODAL CLONAR SOLICITUD - DESPACHADOR -->
<div class="modal fade" id="modalClonarSolicitudDesp" tabindex="-1" role="dialog" aria-labelledby="modalClonarSolicitudDespLabel" aria-hidden="true" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalClonarSolicitudDespLabel">
                    <i class="fas fa-copy mr-2"></i>Clonar Solicitud
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation Principal -->
                <ul class="nav nav-tabs nav-justified mb-4" id="clonarDespMainTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="clonarDesp-solicitud-tab" data-toggle="tab" href="#clonarDesp-solicitud" role="tab" aria-controls="clonarDesp-solicitud" aria-selected="true">
                            <i class="fas fa-file-alt mr-2"></i>Detalle de Solicitud
                        </a>
                    </li>
                    <li class="nav-item" id="clonarDesp-aprobadores-tab-li" style="display: none;">
                        <a class="nav-link" id="clonarDesp-aprobadores-tab" data-toggle="tab" href="#clonarDesp-aprobadores" role="tab" aria-controls="clonarDesp-aprobadores" aria-selected="false">
                            <i class="fas fa-user-check mr-2"></i>Aprobadores
                        </a>
                    </li>
                    <li class="nav-item" id="clonarDesp-distribucion-tab-li" style="display: none;">
                        <a class="nav-link" id="clonarDesp-distribucion-tab" data-toggle="tab" href="#clonarDesp-distribucion" role="tab" aria-controls="clonarDesp-distribucion" aria-selected="false">
                            <i class="fas fa-share-alt mr-2"></i>Lista de Distribución
                        </a>
                    </li>
                </ul>

                <!-- Tabs Content Principal -->
                <div class="tab-content" id="clonarDespMainTabsContent">
                    <!-- Tab: Detalle de Solicitud -->
                    <div class="tab-pane fade show active" id="clonarDesp-solicitud" role="tabpanel" aria-labelledby="clonarDesp-solicitud-tab">
                        <form id="formClonarSolicitudDesp">
                <!-- Leyenda de Colores -->
                <div class="alert alert-info mb-3" role="alert">
                    <div class="row">
                        <div class="col-md-6">
                            <i class="fas fa-check-circle text-success mr-2"></i>
                            <strong class="text-success">Verde:</strong> Valores copiados de la solicitud original (editables)
                        </div>
                        <div class="col-md-6">
                            <i class="fas fa-exclamation-circle text-warning mr-2"></i>
                            <strong class="text-warning">Amarillo:</strong> Valores por definir (debe completarlos)
                        </div>
                    </div>
                </div>

                <!-- Header: Estado -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-info-circle mr-2"></i>Estado</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-info mb-0" role="alert">
                                    <i class="fas fa-user-clock mr-2"></i>
                                    <strong>Estado por defecto al clonar:</strong> <span class="badge badge-info ml-2">Despachador Gestionando</span>
                                    <small class="d-block mt-1 text-muted">La solicitud clonada se creará en estado Despachador Gestionando</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Identificación (MIXTO) -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-id-card mr-2"></i>Identificación</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">ID <span class="badge badge-warning">VACÍO</span></label>
                                    <input type="text" class="form-control" id="clonarDespIDSolicitud" name="idSolicitud" placeholder="Ej: CEN-2025-001">
                                    <small class="form-text text-muted">Debe completarlo</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo de Trabajo<span class="text-danger">*</span> <span class="badge badge-success">COPIADO</span></label>
                                    <select class="form-control" id="clonarDespTipo" name="tipo" required>
                                        <option value="">Seleccione...</option>
                                            <option value="SDCN">SDCN - Solicitud de Desconexión Curso Normal</option>
                                            <option value="SDCF">SDCF - Solicitud de Desconexión Curso Forzoso</option>
                                            <option value="SICN">SICN - Solicitud de Intervención Curso Normal</option>
                                            <option value="SICF">SICF - Solicitud de Intervención Curso Forzoso</option>
                                            <option value="IL">IL - Informe de Limitación</option>
                                            <option value="MM">MM - Mantención Mayor</option>
                                            <option value="SODI">SODI - Solicitud de Desconexión/Intervención</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Relación SODI/CEN <span class="badge badge-success">COPIADO</span></label>
                                    <textarea class="form-control" id="clonarDespRelacionSODICEN" name="relacionSODICEN" rows="1" placeholder="Ej: CEN-2025-001, SODI-123"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Fechas Programadas (QUEDAN VACÍAS) -->
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="far fa-calendar-alt mr-2"></i>Fechas Programadas <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Fecha y hora programada de inicio <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="clonarDespInicioProgramado" name="inicioProgramado" required>
                                    <small class="form-text text-muted">Debe ser una fecha futura</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Fecha y hora programada de fin <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="clonarDespFinProgramado" name="finProgramado" required>
                                    <small class="form-text text-muted">Debe ser posterior a la fecha de inicio</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Empresas Involucradas (SE COPIA VALOR) -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-handshake mr-2"></i>Empresas Involucradas <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Empresa Solicitante <span class="text-danger">*</span></label>
                                    <select class="form-control" id="clonarDespEmpresaSolicitante" name="empresaSolicitante" required>
                                        <option value="">Seleccione...</option>
                                        <option value="CDC">CDC</option>
                                        <option value="GM">GM</option>
                                        <option value="Transelec Norte">Transelec Norte</option>
                                        <option value="Transelec Sur">Transelec Sur</option>
                                        <option value="Chilquinta">Chilquinta</option>
                                        <option value="Saesa">Saesa</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Empresa Receptora <span class="text-danger">*</span></label>
                                    <select class="form-control" id="clonarDespEmpresaReceptora" name="empresaReceptora" required>
                                        <option value="">Seleccione...</option>
                                        <option value="CDC">CDC</option>
                                        <option value="GM">GM</option>
                                        <option value="Transelec Norte">Transelec Norte</option>
                                        <option value="Transelec Sur">Transelec Sur</option>
                                        <option value="Chilquinta">Chilquinta</option>
                                        <option value="Saesa">Saesa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Instalación y Equipos (SE COPIA VALOR) -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-cogs mr-2"></i>Instalación y Equipos <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Instalación GM <span class="text-danger">*</span></label>
                                    <select class="form-control" id="clonarDespInstalacionGM" name="instalacionGM" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Santiago Solar">Santiago Solar</option>
                                        <option value="Nueva Renca">Nueva Renca</option>
                                        <option value="Los Vientos">Los Vientos</option>
                                        <option value="Santa Lidia">Santa Lidia</option>
                                        <option value="CEME1">CEME1</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Instalaciones/Equipos a intervenir <span class="text-danger">*</span></label>
                                    <select class="form-control" id="clonarDespEquipos" name="equipos" multiple required size="4" disabled>
                                        <option value="">Primero seleccione Instalación GM</option>
                                    </select>
                                    <small class="form-text text-muted">Mantén presionado Ctrl (Cmd en Mac) para seleccionar múltiples opciones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Características de la Intervención (SE COPIA VALOR) -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-wrench mr-2"></i>Características de la Intervención <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo de Intervención <span class="text-danger">*</span></label>
                                    <select class="form-control" id="clonarDespTipoIntervencion" name="tipoIntervencion" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Intervención">Intervención</option>
                                        <option value="Desconexión">Desconexión</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Potencia (MWH) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="clonarDespPotencia" name="potencia" step="0.01" min="0" required placeholder="Ej: 150.50">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Aplica SODI <span class="text-danger">*</span></label>
                                    <select class="form-control" id="clonarDespAplicaSODI" name="aplicaSODI" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Clasificación del Riesgo <span class="text-danger">*</span></label>
                                    <select class="form-control" id="clonarDespRiesgo" name="riesgo" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Bajo">Bajo</option>
                                        <option value="Medio">Medio</option>
                                        <option value="Alto">Alto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- Campo condicional: Descripción del Riesgo del Trabajo -->
                        <div class="row" id="clonarDespDescripcionRiesgoContainer">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción del Riesgo del Trabajo <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="clonarDespDescripcionRiesgo" name="descripcionRiesgo" rows="2" placeholder="Describa el riesgo identificado..."></textarea>
                                    <small class="form-text text-muted">Describa el riesgo identificado para cualquier nivel de clasificación</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Descripción y Condiciones (SE COPIA VALOR) -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-file-alt mr-2"></i>Descripción y Condiciones <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Descripción del trabajo a realizar <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="clonarDespDescripcion" name="descripcion" rows="3" required minlength="10" placeholder="Describa detalladamente el trabajo a realizar..."></textarea>
                                    <small class="form-text text-muted">Mínimo 10 caracteres</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Condiciones requeridas <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="clonarDespCondiciones" name="condiciones" rows="3" required placeholder="Especifique las condiciones necesarias..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Comentarios</label>
                                    <textarea class="form-control" id="clonarDespComentarios" name="comentarios" rows="2" placeholder="Comentarios adicionales (opcional)..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Afectaciones</label>
                                    <select class="form-control" id="clonarDespAfectaciones" name="afectaciones">
                                        <option value="">Seleccione...</option>
                                        <option value="SSCC">SSCC</option>
                                        <option value="Protecciones">Protecciones</option>
                                        <option value="Medidores">Medidores</option>
                                        <option value="SSCC, Protecciones">SSCC, Protecciones</option>
                                        <option value="SSCC, Medidores">SSCC, Medidores</option>
                                        <option value="Protecciones, Medidores">Protecciones, Medidores</option>
                                        <option value="SSCC, Protecciones, Medidores">SSCC, Protecciones, Medidores</option>
                                    </select>
                                    <small class="form-text text-muted">Opcional</small>
                                </div>
                            </div>
                        </div>
                        <!-- Campo condicional: Descripción de la Afectación -->
                        <div class="row" id="clonarDespDescripcionAfectacionContainer" style="display: none;">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción de la Afectación <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="clonarDespDescripcionAfectacion" name="descripcionAfectacion" rows="2" placeholder="Describa la afectación..."></textarea>
                                    <small class="form-text text-muted">Obligatorio cuando se selecciona alguna afectación</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Archivos Adjuntos (QUEDAN VACÍOS) -->
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark py-2">
                        <h6 class="mb-0"><i class="fas fa-paperclip mr-2"></i>Archivos Adjuntos <span class="badge badge-light ml-2">EDITABLE</span></h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Carga de archivo</label>
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="clonarDespAdjunto" name="adjunto" accept=".pdf,.doc,.docx,.xls,.xlsx">
                                        <label class="custom-file-label" for="clonarDespAdjunto">Seleccionar archivo...</label>
                                    </div>
                                    <small class="form-text text-muted">Formatos permitidos: PDF, Word, Excel (Opcional)</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">SODI Adjunta</label>
                                    <select class="form-control" id="clonarDespSODIAdjunto" name="sodiAdjunto">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                    <small class="form-text text-muted">Opcional</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </form>                    </div>
                    <!-- Fin Tab: Detalle de Solicitud -->

                    <!-- Tab: Aprobadores -->
                    <div class="tab-pane fade" id="clonarDesp-aprobadores" role="tabpanel" aria-labelledby="clonarDesp-aprobadores-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Aprobadores:</strong> Personas que deben aprobar esta solicitud.
                        </div>

                        <div class="card">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-user-check mr-2"></i>Aprobadores Asignados</h6>
                            </div>
                            <div class="card-body">
                                <div id="clonarDesp-listaAprobadores" class="border rounded p-3" style="min-height: 200px;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <p>No hay aprobadores asignados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Aprobadores -->

                    <!-- Tab: Lista de Distribución -->
                    <div class="tab-pane fade" id="clonarDesp-distribucion" role="tabpanel" aria-labelledby="clonarDesp-distribucion-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Distribución:</strong> Personas que reciben notificaciones sobre esta solicitud.
                        </div>

                        <div class="card">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-share-alt mr-2"></i>Lista de Distribución</h6>
                            </div>
                            <div class="card-body">
                                <div id="clonarDesp-listaDistribucion" class="border rounded p-3" style="min-height: 200px;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-envelope fa-2x mb-2"></i>
                                        <p>No hay usuarios en la lista de distribución</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Lista de Distribución -->
                </div>
                <!-- Fin Tabs Content Principal -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-info" onclick="confirmarClonarSolicitud()">
                    <i class="fas fa-copy mr-2"></i>Clonar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script para lógica condicional del modal clonar despachador -->
<script>
$(document).ready(function() {
    // Lógica condicional para DESCRIPCION_RIESGO - Ahora se muestra siempre
    $('#clonarDespRiesgo').on('change', function() {
        const riesgo = $(this).val();
        const textarea = $('#clonarDespDescripcionRiesgo');
        
        // El campo siempre es obligatorio cuando se selecciona un riesgo
        if (riesgo && riesgo !== '') {
            textarea.attr('required', 'required');
        } else {
            textarea.removeAttr('required');
        }
    });
    
    // Lógica condicional para DESCRIPCION_AFECTACION
    $('#clonarDespAfectaciones').on('change', function() {
        const afectaciones = $(this).val();
        const container = $('#clonarDespDescripcionAfectacionContainer');
        const textarea = $('#clonarDespDescripcionAfectacion');
        
        if (afectaciones && afectaciones !== '') {
            container.slideDown();
            textarea.attr('required', 'required');
        } else {
            container.slideUp();
            textarea.removeAttr('required').val('');
        }
    });
    
    // Mostrar nombre de archivo seleccionado
    $('#clonarDespAdjunto').on('change', function() {
        const fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').html(fileName || 'Seleccionar archivo...');
    });
});
</script>
