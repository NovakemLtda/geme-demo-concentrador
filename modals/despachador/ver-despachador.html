<!-- MODAL VER SOLICITUD - DESPACHADOR (UNIFICADO) -->
<div class="modal fade" id="modalVerDespachador" tabindex="-1" role="dialog" aria-labelledby="modalVerDespachadorLabel" aria-hidden="true" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalVerDespachadorLabel">
                    <i class="fas fa-eye mr-2"></i>Detalle de Solicitud
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation Principal -->
                <ul class="nav nav-tabs nav-justified mb-4" id="verDespMainTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="verDesp-solicitud-tab" data-toggle="tab" href="#verDesp-solicitud" role="tab" aria-controls="verDesp-solicitud" aria-selected="true">
                            <i class="fas fa-file-alt mr-2"></i>Detalle de Solicitud
                        </a>
                    </li>
                    <li class="nav-item" id="verDesp-aprobadores-tab-li" style="display: none;">
                        <a class="nav-link" id="verDesp-aprobadores-tab" data-toggle="tab" href="#verDesp-aprobadores" role="tab" aria-controls="verDesp-aprobadores" aria-selected="false">
                            <i class="fas fa-user-check mr-2"></i>Aprobadores
                        </a>
                    </li>
                    <li class="nav-item" id="verDesp-distribucion-tab-li" style="display: none;">
                        <a class="nav-link" id="verDesp-distribucion-tab" data-toggle="tab" href="#verDesp-distribucion" role="tab" aria-controls="verDesp-distribucion" aria-selected="false">
                            <i class="fas fa-share-alt mr-2"></i>Lista de Distribución
                        </a>
                    </li>
                </ul>

                <!-- Tabs Content Principal -->
                <div class="tab-content" id="verDespMainTabsContent">
                    <!-- Tab: Detalle de Solicitud -->
                    <div class="tab-pane fade show active" id="verDesp-solicitud" role="tabpanel" aria-labelledby="verDesp-solicitud-tab">
                        <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-info-circle mr-2"></i>Estado y Observaciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="alert mb-0 d-flex align-items-center" role="alert" id="verDespEstadoAlert">
                                    <i class="fas fa-circle mr-2"></i>
                                    <div>
                                        <strong>Estado:</strong> <span class="badge ml-2" id="verDespEstadoBadge">-</span>
                                        <small class="d-block mt-1 text-muted" id="verDespEstadoDescripcion">-</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1"><strong>Observaciones:</strong></label>
                                    <p class="mb-0" id="verDespObservaciones">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Identificación -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-id-card mr-2"></i>Identificación</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">ID Solicitud</label>
                                    <input type="text" class="form-control" id="verDespIDSolicitud" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo de Trabajo</label>
                                    <input type="text" class="form-control" id="verDespTipo" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Relación SODI/CEN</label>
                                    <input type="text" class="form-control" id="verDespRelacionSODICEN" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Fechas Programadas -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="far fa-calendar-alt mr-2"></i>Fechas Programadas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Inicio Programado</label>
                                    <input type="text" class="form-control" id="verDespInicioProgramado" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Fin Programado</label>
                                    <input type="text" class="form-control" id="verDespFinProgramado" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Fechas Efectivas de Ejecución (Solo en ciertos estados) -->
                <div class="card mb-3" id="verDespFechasEfectivasCard">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-clock mr-2"></i>Fechas Efectivas de Ejecución</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Inicio Efectivo</label>
                                    <input type="text" class="form-control" id="verDespInicioEfectivo" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Fin Efectivo</label>
                                    <input type="text" class="form-control" id="verDespFinEfectivo" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Empresas Involucradas -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-building mr-2"></i>Empresas Involucradas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Empresa Solicitante</label>
                                    <input type="text" class="form-control" id="verDespEmpresaSolicitante" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Empresa Receptora</label>
                                    <input type="text" class="form-control" id="verDespEmpresaReceptora" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Instalación y Equipos -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-cogs mr-2"></i>Instalación y Equipos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Instalación GM</label>
                                    <input type="text" class="form-control" id="verDespInstalacionGM" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Instalaciones/equipos a intervenir</label>
                                    <select class="form-control" id="verDespEquipos" multiple readonly size="4">
                                        <option value="">No hay equipos seleccionados</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Características de la Intervención -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-wrench mr-2"></i>Características de la Intervención</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Tipo de Intervención</label>
                                    <input type="text" class="form-control" id="verDespTipoIntervencion" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Potencia (MWH)</label>
                                    <input type="text" class="form-control" id="verDespPotencia" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Aplica SODI</label>
                                    <input type="text" class="form-control" id="verDespAplicaSODI" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Clasificación del Riesgo</label>
                                    <input type="text" class="form-control" id="verDespRiesgo" readonly>
                                </div>
                            </div>
                        </div>
                        <!-- Campo condicional: Descripción del Riesgo del Trabajo -->
                        <div class="row" id="verDespDescripcionRiesgoContainer">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción del Riesgo del Trabajo</label>
                                    <textarea class="form-control" id="verDespDescripcionRiesgo" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Descripción y Condiciones -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>Descripción y Condiciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Descripción del trabajo</label>
                                    <textarea class="form-control" id="verDespDescripcion" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Condiciones requeridas</label>
                                    <textarea class="form-control" id="verDespCondiciones" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Comentarios</label>
                                    <textarea class="form-control" id="verDespComentarios" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Afectaciones</label>
                                    <input type="text" class="form-control" id="verDespAfectaciones" readonly>
                                </div>
                            </div>
                        </div>
                        <!-- Campo condicional: Descripción de la Afectación -->
                        <div class="row" id="verDespDescripcionAfectacionContainer" style="display: none;">
                            <div class="col-md-12">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Descripción de la Afectación</label>
                                    <textarea class="form-control" id="verDespDescripcionAfectacion" rows="2" readonly></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección: Archivos Adjuntos -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-paperclip mr-2"></i>Archivos Adjuntos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Archivo adjunto</label>
                                    <div>
                                        <span id="verDespAdjunto" class="text-muted">-</span>
                                        <button type="button" class="btn btn-sm btn-primary ml-2" id="verDespDescargarAdjunto" style="display:none;">
                                            <i class="fas fa-download mr-1"></i>Descargar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">SODI Adjunta</label>
                                    <input type="text" class="form-control" id="verDespSODIAdjunto" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer: Información del Sistema -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0 text-primary"><i class="fas fa-info mr-2"></i>Información del Sistema</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">ID</label>
                                    <input type="text" class="form-control form-control-sm" id="verDespIDRegistro" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Creado</label>
                                    <input type="text" class="form-control form-control-sm" id="verDespCreado" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Actualizado</label>
                                    <input type="text" class="form-control form-control-sm" id="verDespActualizado" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Administrador</label>
                                    <input type="text" class="form-control form-control-sm" id="verDespAdministrador" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="text-muted small mb-1">Solicitante</label>
                                    <input type="text" class="form-control form-control-sm" id="verDespSolicitante" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group mb-0">
                                    <label class="text-muted small mb-1">Creado Por</label>
                                    <input type="text" class="form-control form-control-sm" id="verDespCreadoPor" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>                    </div>
                    <!-- Fin Tab: Detalle de Solicitud -->

                    <!-- Tab: Aprobadores -->
                    <div class="tab-pane fade" id="verDesp-aprobadores" role="tabpanel" aria-labelledby="verDesp-aprobadores-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Aprobadores:</strong> Personas que deben aprobar esta solicitud.
                        </div>

                        <div class="card">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-user-check mr-2"></i>Aprobadores Asignados</h6>
                            </div>
                            <div class="card-body">
                                <div id="verDesp-listaAprobadores" class="border rounded p-3" style="min-height: 200px;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <p>No hay aprobadores asignados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Aprobadores -->

                    <!-- Tab: Lista de Distribución -->
                    <div class="tab-pane fade" id="verDesp-distribucion" role="tabpanel" aria-labelledby="verDesp-distribucion-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Distribución:</strong> Personas que reciben notificaciones sobre esta solicitud.
                        </div>

                        <div class="card">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-share-alt mr-2"></i>Lista de Distribución</h6>
                            </div>
                            <div class="card-body">
                                <div id="verDesp-listaDistribucion" class="border rounded p-3" style="min-height: 200px;">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-envelope fa-2x mb-2"></i>
                                        <p>No hay usuarios en la lista de distribución</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Lista de Distribución -->
                </div>
                <!-- Fin Tabs Content Principal -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script para lógica condicional del modal de visualización -->
<script>
// Función para configurar la visibilidad de secciones según el estado
function configurarVisibilidadVerDespachador(estado) {
    // Mostrar Fechas Efectivas solo en estados: Vigente, Extendida, Finalizada, Rechazada, Suspendida
    const estadosConFechasEfectivas = ['Vigente', 'Extendida', 'Finalizada', 'Rechazada', 'Suspendida'];
    if (estadosConFechasEfectivas.includes(estado)) {
        $('#verDespFechasEfectivasCard').show();
    } else {
        $('#verDespFechasEfectivasCard').hide();
    }
}

// Función para mostrar/ocultar campos condicionales según los datos
function configurarCamposCondicionalesVerDesp(solicitud) {
    // Mostrar DESCRIPCION_RIESGO si existe (para cualquier nivel de riesgo)
    if (solicitud.DESCRIPCION_RIESGO) {
        $('#verDespDescripcionRiesgo').val(solicitud.DESCRIPCION_RIESGO);
        $('#verDespDescripcionRiesgoContainer').show();
    } else {
        $('#verDespDescripcionRiesgoContainer').hide();
    }
    
    // Mostrar DESCRIPCION_AFECTACION si existe y hay afectaciones
    if (solicitud.DESCRIPCION_AFECTACION && solicitud.AFECTACIONES) {
        $('#verDespDescripcionAfectacion').val(solicitud.DESCRIPCION_AFECTACION);
        $('#verDespDescripcionAfectacionContainer').show();
    } else {
        $('#verDespDescripcionAfectacionContainer').hide();
    }
}
</script>
