<!-- MODAL EDITAR SOLICITUD -->
<div class="modal fade" id="modalEditarSolicitudSolic" tabindex="-1" role="dialog" aria-labelledby="modalEditarSolicitudSolicLabel" aria-hidden="true" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEditarSolicitudSolicLabel">
                    <i class="fas fa-edit mr-2"></i>Editar Solicitud
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation Principal -->
                <ul class="nav nav-tabs nav-justified mb-4" id="editarSolicMainTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="editarSolic-formulario-tab" data-toggle="tab" href="#editarSolic-formulario" role="tab" aria-controls="editarSolic-formulario" aria-selected="true">
                            <i class="fas fa-edit mr-2"></i>Formulario de Solicitud
                        </a>
                    </li>
                    <li class="nav-item" id="editarSolic-aprobadores-tab-li" style="display: none;">
                        <a class="nav-link" id="editarSolic-aprobadores-tab" data-toggle="tab" href="#editarSolic-aprobadores" role="tab" aria-controls="editarSolic-aprobadores" aria-selected="false">
                            <i class="fas fa-user-check mr-2"></i>Aprobadores
                        </a>
                    </li>
                    <li class="nav-item" id="editarSolic-distribucion-tab-li" style="display: none;">
                        <a class="nav-link" id="editarSolic-distribucion-tab" data-toggle="tab" href="#editarSolic-distribucion" role="tab" aria-controls="editarSolic-distribucion" aria-selected="false">
                            <i class="fas fa-share-alt mr-2"></i>Lista de Distribución
                        </a>
                    </li>
                </ul>

                <!-- Tabs Content Principal -->
                <div class="tab-content" id="editarSolicMainTabsContent">
                    <!-- Tab: Formulario de Solicitud -->
                    <div class="tab-pane fade show active" id="editarSolic-formulario" role="tabpanel" aria-labelledby="editarSolic-formulario-tab">
                        <form id="formEditarSolicitudSolic">
                            <!-- Leyenda de campos obligatorios -->
                            <div class="alert alert-info mb-3" role="alert">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <div>
                                        <strong>Leyenda:</strong>
                                        <span class="ml-3"><span class="text-danger">*</span> Campos obligatorios</span>
                                    </div>
                                </div>
                            </div>

                    <!-- Header: Estado (SOLO LECTURA) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-info-circle mr-2"></i>Estado</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="alert mb-0" role="alert" id="editarSolicEstadoAlert">
                                        <i class="fas fa-cog mr-2"></i>
                                        <strong>Estado:</strong> <span class="badge ml-2" id="editarSolicEstadoBadge">-</span>
                                        <small class="d-block mt-1 text-muted">Solo se pueden editar solicitudes en estado Pendiente o Devuelta</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Fechas Programadas (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="far fa-calendar-alt mr-2"></i>Fechas Programadas</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Fecha y hora programada de inicio <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="editarSolicInicioProgramado" name="inicioProgramado" required>
                                        <small class="form-text text-muted">Debe ser una fecha futura</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Fecha y hora programada de fin <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="editarSolicFinProgramado" name="finProgramado" required>
                                        <small class="form-text text-muted">Debe ser posterior a la fecha de inicio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Instalación y Equipos (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-cogs mr-2"></i>Instalación y Equipos</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Instalación GM <span class="text-danger">*</span></label>
                                        <select class="form-control" id="editarSolicInstalacionGM" name="instalacionGM" required>
                                            <option value="">Seleccione...</option>
                                            <option value="Santiago Solar">Santiago Solar</option>
                                            <option value="Nueva Renca">Nueva Renca</option>
                                            <option value="Los Vientos">Los Vientos</option>
                                            <option value="Santa Lidia">Santa Lidia</option>
                                            <option value="CEME1">CEME1</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Instalaciones/equipos a intervenir <span class="text-danger">*</span></label>
                                        <select class="form-control" id="editarSolicEquipos" name="equipos" multiple required disabled size="4">
                                            <option value="">Primero seleccione Instalación GM</option>
                                        </select>
                                        <small class="form-text text-muted">Mantén presionado Ctrl (Cmd en Mac) para seleccionar múltiples opciones</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Características de la Intervención (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-wrench mr-2"></i>Características de la Intervención</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Tipo de intervención <span class="text-danger">*</span></label>
                                        <select class="form-control" id="editarSolicTipoIntervencion" name="tipoIntervencion" required>
                                            <option value="">Seleccione...</option>
                                            <option value="Intervención">Intervención</option>
                                            <option value="Desconexión">Desconexión</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Potencia (MWH)</label>
                                        <input type="number" class="form-control" id="editarSolicPotencia" name="potencia" step="0.01" min="0" placeholder="Ej: 150.50">
                                        <small class="form-text text-muted">Opcional - Dos decimales</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">SODI <span class="text-danger">*</span></label>
                                        <div class="mt-2">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="editarSolicAplicaSODI" id="editarSolicAplicaSODISi" value="Sí" required>
                                                <label class="form-check-label" for="editarSolicAplicaSODISi">Sí</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="editarSolicAplicaSODI" id="editarSolicAplicaSODINo" value="No">
                                                <label class="form-check-label" for="editarSolicAplicaSODINo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Clasificación del Riesgo <span class="text-danger">*</span></label>
                                        <select class="form-control" id="editarSolicRiesgo" name="riesgo" required>
                                            <option value="">Seleccione...</option>
                                            <option value="Bajo">Bajo</option>
                                            <option value="Medio">Medio</option>
                                            <option value="Alto">Alto</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Campo condicional: Descripción del Riesgo del Trabajo -->
                            <div class="row" id="editarSolicDescripcionRiesgoContainer">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Descripción del Riesgo del Trabajo <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="editarSolicDescripcionRiesgo" name="descripcionRiesgo" rows="2" placeholder="Describa el riesgo identificado..."></textarea>
                                        <small class="form-text text-muted">Describa el riesgo identificado para cualquier nivel de clasificación</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Descripción y Condiciones (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>Descripción y Condiciones</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Descripción del trabajo a realizar <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="editarSolicDescripcion" name="descripcion" rows="3" required minlength="10" placeholder="Describa detalladamente el trabajo a realizar..."></textarea>
                                        <small class="form-text text-muted">Mínimo 10 caracteres</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Condiciones requeridas <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="editarSolicCondiciones" name="condiciones" rows="3" required placeholder="Especifique las condiciones necesarias..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Comentarios</label>
                                        <textarea class="form-control" id="editarSolicComentarios" name="comentarios" rows="2" placeholder="Comentarios adicionales (opcional)..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Afectaciones</label>
                                        <select class="form-control" id="editarSolicAfectaciones" name="afectaciones">
                                            <option value="">Seleccione...</option>
                                            <option value="SSCC">SSCC</option>
                                            <option value="Protecciones">Protecciones</option>
                                            <option value="Medidores">Medidores</option>
                                            <option value="SSCC, Protecciones">SSCC, Protecciones</option>
                                            <option value="SSCC, Medidores">SSCC, Medidores</option>
                                            <option value="Protecciones, Medidores">Protecciones, Medidores</option>
                                            <option value="SSCC, Protecciones, Medidores">SSCC, Protecciones, Medidores</option>
                                        </select>
                                        <small class="form-text text-muted">Opcional</small>
                                    </div>
                                </div>
                            </div>
                            <!-- Campo condicional: Descripción de la Afectación -->
                            <div class="row" id="editarSolicDescripcionAfectacionContainer" style="display: none;">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Descripción de la afectación <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="editarSolicDescripcionAfectacion" name="descripcionAfectacion" rows="2" placeholder="Describa la afectación identificada..."></textarea>
                                        <small class="form-text text-muted">Obligatorio cuando se selecciona alguna afectación</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Archivos Adjuntos (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-paperclip mr-2"></i>Archivos Adjuntos</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Carga de archivo</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="editarSolicAdjunto" name="adjunto" accept=".pdf,.doc,.docx,.xls,.xlsx">
                                            <label class="custom-file-label" for="editarSolicAdjunto">Seleccionar archivo...</label>
                                        </div>
                                        <small class="form-text text-muted">Formatos permitidos: PDF, Word, Excel (Opcional)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                            <!-- ID oculto de la solicitud -->
                            <input type="hidden" id="editarSolicID" name="solicitudId">
                        </form>
                    </div>
                    <!-- Fin Tab: Formulario de Solicitud -->

                    <!-- Tab: Aprobadores -->
                    <div class="tab-pane fade" id="editarSolic-aprobadores" role="tabpanel" aria-labelledby="editarSolic-aprobadores-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Aprobadores:</strong> Seleccione las personas que deben aprobar esta solicitud.
                        </div>

                        <div class="row">
                            <!-- Panel Izquierdo: Búsqueda y Lista de Aprobadores Disponibles -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-primary"><i class="fas fa-search mr-2"></i>Buscar Aprobadores</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Campo de búsqueda -->
                                        <div class="form-group">
                                            <input type="text" class="form-control" id="editarSolic-buscarAprobador" placeholder="Buscar por nombre o email...">
                                        </div>

                                        <!-- Lista de Últimos Aprobadores Utilizados -->
                                        <div class="mb-2">
                                            <small class="text-muted">Últimos aprobadores utilizados:</small>
                                        </div>
                                        <div id="editarSolic-listaAprobadoresDisponibles" class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                            <!-- Se llenará dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel Derecho: Aprobadores Seleccionados -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white py-2">
                                        <h6 class="mb-0"><i class="fas fa-user-check mr-2"></i>Aprobadores Seleccionados</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Lista de Aprobadores Seleccionados -->
                                        <div class="mb-2">
                                            <small class="text-muted">Lista de aprobación (<span id="editarSolic-contadorAprobadores">0</span>):</small>
                                        </div>
                                        <div id="editarSolic-listaAprobadoresSeleccionados" class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-users fa-2x mb-2"></i>
                                                <p>No hay aprobadores seleccionados</p>
                                                <small>Seleccione aprobadores de la lista de la izquierda</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Aprobadores -->

                    <!-- Tab: Lista de Distribución -->
                    <div class="tab-pane fade" id="editarSolic-distribucion" role="tabpanel" aria-labelledby="editarSolic-distribucion-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Distribución:</strong> Seleccione las personas que recibirán notificaciones sobre esta solicitud.
                        </div>

                        <div class="row">
                            <!-- Panel Izquierdo: Búsqueda y Lista de Usuarios Disponibles -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-primary"><i class="fas fa-search mr-2"></i>Buscar Usuarios</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Campo de búsqueda -->
                                        <div class="form-group">
                                            <input type="text" class="form-control" id="editarSolic-buscarUsuario" placeholder="Buscar por nombre o email...">
                                        </div>

                                        <!-- Lista de Usuarios Disponibles -->
                                        <div class="mb-2">
                                            <small class="text-muted">Usuarios disponibles:</small>
                                        </div>
                                        <div id="editarSolic-listaDistribucionDisponible" class="border rounded p-2" style="height: 350px; overflow-y: auto;">
                                            <!-- Se llenará dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel Derecho: Lista de Distribución Seleccionada -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white py-2">
                                        <h6 class="mb-0"><i class="fas fa-share-alt mr-2"></i>Lista de Distribución</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Lista de Distribución Seleccionada -->
                                        <div class="mb-2">
                                            <small class="text-muted">Usuarios en lista (<span id="editarSolic-contadorDistribucion">0</span>):</small>
                                        </div>
                                        <div id="editarSolic-listaDistribucionSeleccionada" class="border rounded p-2" style="height: 350px; overflow-y: auto;">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-envelope fa-2x mb-2"></i>
                                                <p>No hay usuarios en la lista</p>
                                                <small>Seleccione usuarios de la lista de la izquierda</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Lista de Distribución -->
                </div>
                <!-- Fin Tabs Content Principal -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="actualizarSolicitud()">
                    <i class="fas fa-save mr-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script para lógica del formulario y gestión de aprobadores/distribución -->
<script>
// Variables globales para gestión de listas - usar GEME_GLOBALS_EDITAR para evitar conflictos
if (typeof window.GEME_GLOBALS_EDITAR === 'undefined') {
    window.GEME_GLOBALS_EDITAR = {
        aprobadoresDisponibles: [],
        aprobadoresSeleccionados: [],
        distribucionDisponible: [],
        distribucionSeleccionada: [],
        initialized: false
    };
}

// Referencias locales a las variables globales
var editarAprobadoresDisponibles = window.GEME_GLOBALS_EDITAR.aprobadoresDisponibles;
var editarAprobadoresSeleccionados = window.GEME_GLOBALS_EDITAR.aprobadoresSeleccionados;
var editarDistribucionDisponible = window.GEME_GLOBALS_EDITAR.distribucionDisponible;
var editarDistribucionSeleccionada = window.GEME_GLOBALS_EDITAR.distribucionSeleccionada;

$(document).ready(function() {
    // Inicializar datos para modal editar
    inicializarAprobadoresEditar();
    inicializarDistribucionEditar();
    
    // Lógica condicional para DESCRIPCION_RIESGO
    $('#editarSolicRiesgo').on('change', function() {
        const riesgo = $(this).val();
        const textarea = $('#editarSolicDescripcionRiesgo');
        
        if (riesgo && riesgo !== '') {
            textarea.prop('required', true);
        } else {
            textarea.prop('required', false);
        }
    });
    
    // Lógica condicional para DESCRIPCION_AFECTACION
    $('#editarSolicAfectaciones').on('change', function() {
        const afectacion = $(this).val();
        const container = $('#editarSolicDescripcionAfectacionContainer');
        const textarea = $('#editarSolicDescripcionAfectacion');
        
        if (afectacion && afectacion !== '') {
            container.slideDown(300);
            textarea.prop('required', true);
        } else {
            container.slideUp(300);
            textarea.prop('required', false);
            textarea.val('');
        }
    });
    
    // Búsqueda de aprobadores
    $('#editarSolic-buscarAprobador').on('input', function() {
        const termino = $(this).val().toLowerCase();
        filtrarAprobadoresEditar(termino);
    });
    
    // Búsqueda de usuarios para distribución
    $('#editarSolic-buscarUsuario').on('input', function() {
        const termino = $(this).val().toLowerCase();
        filtrarDistribucionEditar(termino);
    });
    
    // Limpiar campos condicionales al cerrar el modal
    $('#modalEditarSolicitudSolic').on('hidden.bs.modal', function() {
        $('#editarSolicDescripcionRiesgo').prop('required', false).val('');
        $('#editarSolicDescripcionAfectacionContainer').hide();
        $('#editarSolicDescripcionAfectacion').prop('required', false).val('');
        
        // Limpiar listas de aprobadores y distribución
        editarAprobadoresSeleccionados.length = 0;
        editarDistribucionSeleccionada.length = 0;
        actualizarListaAprobadoresSeleccionadosEditar();
        actualizarListaDistribucionSeleccionadaEditar();
    });
});

// ============================================
// FUNCIONES PARA GESTIÓN DE APROBADORES - MODAL EDITAR
// ============================================

function inicializarAprobadoresEditar() {
    // Lista de aprobadores disponibles (simulada)
    editarAprobadoresDisponibles.length = 0;
    editarAprobadoresDisponibles.push(
        { nombre: 'Ignacio Soto', email: 'ignacio.soto@empresa.cl' },
        { nombre: 'Daniela Campos', email: 'daniela.campos@empresa.cl' },
        { nombre: 'Francisca Vega', email: 'francisca.vega@empresa.cl' },
        { nombre: 'Carlos Rojas', email: 'carlos.rojas@empresa.cl' },
        { nombre: 'Ana Martínez', email: 'ana.martinez@empresa.cl' },
        { nombre: 'Pedro Silva', email: 'pedro.silva@empresa.cl' }
    );
    
    mostrarAprobadoresDisponiblesEditar();
}

function mostrarAprobadoresDisponiblesEditar() {
    const container = $('#editarSolic-listaAprobadoresDisponibles');
    container.empty();
    
    editarAprobadoresDisponibles.forEach((aprobador, index) => {
        const isSelected = editarAprobadoresSeleccionados.some(sel => sel.email === aprobador.email);
        const html = `
            <div class="aprobador-disponible-item p-2 mb-2 border rounded ${isSelected ? 'bg-light' : 'bg-white'}" 
                 style="cursor: ${isSelected ? 'not-allowed' : 'pointer'};" 
                 onclick="${isSelected ? '' : `seleccionarAprobadorEditar(${index})`}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="${isSelected ? 'text-muted' : 'text-dark'}">${aprobador.nombre}</strong>
                        <br><small class="${isSelected ? 'text-muted' : 'text-secondary'}">${aprobador.email}</small>
                    </div>
                    <div>
                        ${isSelected ? 
                            '<i class="fas fa-check-circle text-success"></i>' : 
                            '<i class="fas fa-plus-circle text-primary"></i>'
                        }
                    </div>
                </div>
            </div>
        `;
        container.append(html);
    });
}

function seleccionarAprobadorEditar(index) {
    const aprobador = editarAprobadoresDisponibles[index];
    
    // Verificar si ya está seleccionado
    if (!editarAprobadoresSeleccionados.some(sel => sel.email === aprobador.email)) {
        editarAprobadoresSeleccionados.push({ ...aprobador });
        actualizarListaAprobadoresSeleccionadosEditar();
        mostrarAprobadoresDisponiblesEditar();
    }
}

function removerAprobadorEditar(index) {
    editarAprobadoresSeleccionados.splice(index, 1);
    actualizarListaAprobadoresSeleccionadosEditar();
    mostrarAprobadoresDisponiblesEditar();
}

function actualizarListaAprobadoresSeleccionadosEditar() {
    const container = $('#editarSolic-listaAprobadoresSeleccionados');
    const contador = $('#editarSolic-contadorAprobadores');
    
    contador.text(editarAprobadoresSeleccionados.length);
    
    if (editarAprobadoresSeleccionados.length === 0) {
        container.html(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>No hay aprobadores seleccionados</p>
                <small>Seleccione aprobadores de la lista de la izquierda</small>
            </div>
        `);
        return;
    }
    
    container.empty();
    editarAprobadoresSeleccionados.forEach((aprobador, index) => {
        const html = `
            <div class="aprobador-seleccionado-item p-2 mb-2 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="text-success">${aprobador.nombre}</strong>
                        <br><small class="text-secondary">${aprobador.email}</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerAprobadorEditar(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        container.append(html);
    });
}

function filtrarAprobadoresEditar(termino) {
    const items = $('#editarSolic-listaAprobadoresDisponibles .aprobador-disponible-item');
    
    items.each(function() {
        const texto = $(this).text().toLowerCase();
        if (texto.includes(termino)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// ============================================
// FUNCIONES PARA GESTIÓN DE DISTRIBUCIÓN - MODAL EDITAR
// ============================================

function inicializarDistribucionEditar() {
    // Lista de usuarios disponibles para distribución (simulada)
    editarDistribucionDisponible.length = 0;
    editarDistribucionDisponible.push(
        { nombre: 'Fernando Castro', email: 'fernando.castro@empresa.cl', usuarioSistema: true },
        { nombre: 'Javiera Rojas', email: 'javiera.rojas@empresa.cl', usuarioSistema: true },
        { nombre: 'Sofía Parra', email: 'sofia.parra@empresa.cl', usuarioSistema: false },
        { nombre: 'Andrés Muñoz', email: 'andres.munoz@empresa.cl', usuarioSistema: false },
        { nombre: 'Carmen López', email: 'carmen.lopez@empresa.cl', usuarioSistema: true },
        { nombre: 'Ricardo Herrera', email: 'ricardo.herrera@empresa.cl', usuarioSistema: false }
    );
    
    mostrarDistribucionDisponibleEditar();
}

function mostrarDistribucionDisponibleEditar() {
    const container = $('#editarSolic-listaDistribucionDisponible');
    container.empty();
    
    editarDistribucionDisponible.forEach((usuario, index) => {
        const isSelected = editarDistribucionSeleccionada.some(sel => sel.email === usuario.email);
        const html = `
            <div class="distribucion-disponible-item p-2 mb-2 border rounded ${isSelected ? 'bg-light' : 'bg-white'}" 
                 style="cursor: ${isSelected ? 'not-allowed' : 'pointer'};" 
                 onclick="${isSelected ? '' : `seleccionarDistribucionEditar(${index})`}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="${isSelected ? 'text-muted' : 'text-dark'}">${usuario.nombre}</strong>
                        <br><small class="${isSelected ? 'text-muted' : 'text-secondary'}">${usuario.email}</small>
                        <br><span class="badge badge-${usuario.usuarioSistema ? 'primary' : 'secondary'} badge-sm">
                            ${usuario.usuarioSistema ? 'Usuario Sistema' : 'Externo'}
                        </span>
                    </div>
                    <div>
                        ${isSelected ? 
                            '<i class="fas fa-check-circle text-success"></i>' : 
                            '<i class="fas fa-plus-circle text-primary"></i>'
                        }
                    </div>
                </div>
            </div>
        `;
        container.append(html);
    });
}

function seleccionarDistribucionEditar(index) {
    const usuario = editarDistribucionDisponible[index];
    
    // Verificar si ya está seleccionado
    if (!editarDistribucionSeleccionada.some(sel => sel.email === usuario.email)) {
        editarDistribucionSeleccionada.push({ ...usuario });
        actualizarListaDistribucionSeleccionadaEditar();
        mostrarDistribucionDisponibleEditar();
    }
}

function removerDistribucionEditar(index) {
    editarDistribucionSeleccionada.splice(index, 1);
    actualizarListaDistribucionSeleccionadaEditar();
    mostrarDistribucionDisponibleEditar();
}

function actualizarListaDistribucionSeleccionadaEditar() {
    const container = $('#editarSolic-listaDistribucionSeleccionada');
    const contador = $('#editarSolic-contadorDistribucion');
    
    contador.text(editarDistribucionSeleccionada.length);
    
    if (editarDistribucionSeleccionada.length === 0) {
        container.html(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-envelope fa-2x mb-2"></i>
                <p>No hay usuarios en la lista</p>
                <small>Seleccione usuarios de la lista de la izquierda</small>
            </div>
        `);
        return;
    }
    
    container.empty();
    editarDistribucionSeleccionada.forEach((usuario, index) => {
        const html = `
            <div class="distribucion-seleccionada-item p-2 mb-2 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong class="text-info">${usuario.nombre}</strong>
                        <br><small class="text-secondary">${usuario.email}</small>
                        <br><span class="badge badge-${usuario.usuarioSistema ? 'primary' : 'secondary'} badge-sm">
                            ${usuario.usuarioSistema ? 'Usuario Sistema' : 'Externo'}
                        </span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerDistribucionEditar(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        container.append(html);
    });
}

function filtrarDistribucionEditar(termino) {
    const items = $('#editarSolic-listaDistribucionDisponible .distribucion-disponible-item');
    
    items.each(function() {
        const texto = $(this).text().toLowerCase();
        if (texto.includes(termino)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// ============================================
// FUNCIÓN PARA CARGAR DATOS EXISTENTES
// ============================================

function cargarDatosExistentesEditar(solicitud) {
    // Limpiar selecciones previas
    editarAprobadoresSeleccionados.length = 0;
    editarDistribucionSeleccionada.length = 0;
    
    // Cargar aprobadores existentes
    if (solicitud.APROBADORES && solicitud.APROBADORES.length > 0) {
        solicitud.APROBADORES.forEach(aprobador => {
            editarAprobadoresSeleccionados.push({
                nombre: aprobador.NOMBRE,
                email: aprobador.EMAIL
            });
        });
    }
    
    // Cargar distribución existente
    if (solicitud.LISTA_DISTRIBUCION && solicitud.LISTA_DISTRIBUCION.length > 0) {
        solicitud.LISTA_DISTRIBUCION.forEach(usuario => {
            editarDistribucionSeleccionada.push({
                nombre: usuario.NOMBRE,
                email: usuario.EMAIL,
                usuarioSistema: usuario.USUARIO_SISTEMA
            });
        });
    }
    
    // Actualizar las listas
    actualizarListaAprobadoresSeleccionadosEditar();
    actualizarListaDistribucionSeleccionadaEditar();
    mostrarAprobadoresDisponiblesEditar();
    mostrarDistribucionDisponibleEditar();
}
</script>
