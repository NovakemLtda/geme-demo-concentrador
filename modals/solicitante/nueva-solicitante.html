<!-- MODAL NUEVA SOLICITUD -->
<div class="modal fade" id="modalNuevaSolicitudSolic" tabindex="-1" role="dialog" aria-labelledby="modalNuevaSolicitudSolicLabel" aria-hidden="true" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalNuevaSolicitudSolicLabel">
                    <i class="fas fa-plus-circle mr-2"></i>Nueva Solicitud
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation Principal -->
                <ul class="nav nav-tabs nav-justified mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="formulario-tab" data-toggle="tab" href="#formulario" role="tab" aria-controls="formulario" aria-selected="true">
                            <i class="fas fa-edit mr-2"></i>Formulario de Solicitud
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="aprobadores-tab" data-toggle="tab" href="#aprobadores" role="tab" aria-controls="aprobadores" aria-selected="false" tabindex="-1" aria-disabled="true">
                            <i class="fas fa-user-check mr-2"></i>Aprobadores
                            <small class="d-block text-muted" style="font-size: 0.7em;">Marque "Requiere Aprobadores" para habilitar</small>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" id="distribucion-tab" data-toggle="tab" href="#distribucion" role="tab" aria-controls="distribucion" aria-selected="false" tabindex="-1" aria-disabled="true">
                            <i class="fas fa-share-alt mr-2"></i>Lista de Distribución
                            <small class="d-block text-muted" style="font-size: 0.7em;">Marque "Requiere Distribución" para habilitar</small>
                        </a>
                    </li>
                </ul>

                <!-- Tabs Content Principal -->
                <div class="tab-content" id="mainTabsContent">
                    <!-- Tab: Formulario de Solicitud -->
                    <div class="tab-pane fade show active" id="formulario" role="tabpanel" aria-labelledby="formulario-tab">
                        <form id="formNuevaSolicitud">
                            <!-- Leyenda de campos obligatorios -->
                            <div class="alert alert-info mb-3" role="alert">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <div>
                                        <strong>Leyenda:</strong>
                                        <span class="ml-3"><span class="text-danger">*</span> Campos obligatorios</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección de Configuración de Aprobación y Distribución -->
                            <div class="card mb-3 border-info">
                                <div class="card-header bg-info text-white py-2">
                                    <h6 class="mb-0"><i class="fas fa-cogs mr-2"></i>Configuración de Aprobación y Distribución</h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-light mb-3" role="alert">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        <strong>Importante:</strong> Configure los requisitos de aprobación antes de completar el formulario. Esto habilitará las pestañas correspondientes.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="custom-control custom-checkbox mb-3">
                                                <input type="checkbox" class="custom-control-input" id="requiereAprobadores" onchange="toggleRequiereAprobadores()">
                                                <label class="custom-control-label" for="requiereAprobadores">
                                                    <i class="fas fa-user-check mr-2 text-primary"></i>
                                                    <strong>Requiere Aprobadores</strong>
                                                    <small class="d-block text-muted">La solicitud necesita aprobación antes de continuar</small>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="custom-control custom-checkbox mb-3">
                                                <input type="checkbox" class="custom-control-input" id="requiereDistribucion" onchange="toggleRequiereDistribucion()">
                                                <label class="custom-control-label" for="requiereDistribucion">
                                                    <i class="fas fa-share-alt mr-2 text-success"></i>
                                                    <strong>Requiere Lista de Distribución</strong>
                                                    <small class="d-block text-muted">La solicitud debe ser notificada a usuarios específicos</small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Alertas de validación -->
                                    <div id="alertaAprobadores" class="alert alert-warning d-none" role="alert">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <strong>Configuración requerida:</strong> Debe configurar al menos un aprobador en la pestaña "Aprobadores" antes de guardar.
                                    </div>
                                    
                                    <div id="alertaDistribucion" class="alert alert-warning d-none" role="alert">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <strong>Configuración requerida:</strong> Debe configurar al menos un usuario en la "Lista de Distribución" antes de guardar.
                                    </div>
                                </div>
                            </div>

                    <!-- Header: Estado -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-info-circle mr-2"></i>Estado</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="alert alert-warning mb-0" role="alert">
                                        <i class="fas fa-clock mr-2"></i>
                                        <strong>Estado por defecto:</strong> <span id="estadoPorDefecto" class="badge badge-warning ml-2">Pendiente</span>
                                        <small id="descripcionEstado" class="d-block mt-1 text-muted">Las solicitudes creadas por el solicitante inician en este estado</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Fechas Programadas -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="far fa-calendar-alt mr-2"></i>Fechas Programadas</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Fecha y hora programada de inicio <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="nuevaSolicInicioProgramado" name="inicioProgramado" required>
                                        <small class="form-text text-muted">Debe ser una fecha futura</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Fecha y hora programada de fin <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="nuevaSolicFinProgramado" name="finProgramado" required>
                                        <small class="form-text text-muted">Debe ser posterior a la fecha de inicio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Instalación y Equipos -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-cogs mr-2"></i>Instalación y Equipos</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Instalación GM <span class="text-danger">*</span></label>
                                        <select class="form-control" id="nuevaSolicInstalacionGM" name="instalacionGM" required>
                                            <option value="">Seleccione...</option>
                                            <option value="Santiago Solar">Santiago Solar</option>
                                            <option value="Nueva Renca">Nueva Renca</option>
                                            <option value="Los Vientos">Los Vientos</option>
                                            <option value="Santa Lidia">Santa Lidia</option>
                                            <option value="CEME1">CEME1</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Instalaciones/equipos a intervenir <span class="text-danger">*</span></label>
                                        <select class="form-control" id="nuevaSolicEquipos" name="equipos" multiple required disabled style="height: 120px;">
                                            <option value="">Primero seleccione Instalación GM</option>
                                        </select>
                                        <small class="form-text text-muted">Mantenga Ctrl (Cmd en Mac) para seleccionar múltiples equipos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Características de la Intervención -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-wrench mr-2"></i>Características de la Intervención</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Tipo de intervención <span class="text-danger">*</span></label>
                                        <select class="form-control" id="nuevaSolicTipoIntervencion" name="tipoIntervencion" required>
                                            <option value="">Seleccione...</option>
                                            <option value="Intervención">Intervención</option>
                                            <option value="Desconexión">Desconexión</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Potencia (MWH) <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="nuevaSolicPotencia" name="potencia" step="0.01" min="0" placeholder="Ej: 150.50" required>
                                        <small class="form-text text-muted">Dos decimales</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Aplica SODI <span class="text-danger">*</span></label>
                                        <div class="mt-2">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="nuevaSolicAplicaSODI" id="nuevaSolicAplicaSODISi" value="Sí" required>
                                                <label class="form-check-label" for="nuevaSolicAplicaSODISi">Sí</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="nuevaSolicAplicaSODI" id="nuevaSolicAplicaSODINo" value="No">
                                                <label class="form-check-label" for="nuevaSolicAplicaSODINo">No</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Clasificación del Riesgo <span class="text-danger">*</span></label>
                                        <select class="form-control" id="nuevaSolicRiesgo" name="riesgo" required>
                                            <option value="">Seleccione...</option>
                                            <option value="Bajo">Bajo</option>
                                            <option value="Medio">Medio</option>
                                            <option value="Alto">Alto</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Campo condicional: Descripción del Riesgo del Trabajo -->
                            <div class="row" id="nuevaSolicDescripcionRiesgoContainer">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Descripción del Riesgo del Trabajo <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="nuevaSolicDescripcionRiesgo" name="descripcionRiesgo" rows="2" placeholder="Describa el riesgo identificado..."></textarea>
                                        <small class="form-text text-muted">Describa el riesgo identificado para cualquier nivel de clasificación</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Descripción y Condiciones -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-file-alt mr-2"></i>Descripción y Condiciones</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Descripción del trabajo a realizar <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="nuevaSolicDescripcion" name="descripcion" rows="3" required minlength="10" placeholder="Describa detalladamente el trabajo a realizar..."></textarea>
                                        <small class="form-text text-muted">Mínimo 10 caracteres</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Condiciones requeridas <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="nuevaSolicCondiciones" name="condiciones" rows="3" required placeholder="Especifique las condiciones necesarias..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Comentarios</label>
                                        <textarea class="form-control" id="nuevaSolicComentarios" name="comentarios" rows="2" placeholder="Comentarios adicionales (opcional)..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="text-muted small mb-1">Afectaciones</label>
                                        <select class="form-control" id="nuevaSolicAfectaciones" name="afectaciones">
                                            <option value="">Seleccione...</option>
                                            <option value="SSCC">SSCC</option>
                                            <option value="Protecciones">Protecciones</option>
                                            <option value="Medidores">Medidores</option>
                                            <option value="SSCC, Protecciones">SSCC, Protecciones</option>
                                            <option value="SSCC, Medidores">SSCC, Medidores</option>
                                            <option value="Protecciones, Medidores">Protecciones, Medidores</option>
                                            <option value="SSCC, Protecciones, Medidores">SSCC, Protecciones, Medidores</option>
                                        </select>
                                        <small class="form-text text-muted">Opcional</small>
                                    </div>
                                </div>
                            </div>
                            <!-- Campo condicional: Descripción de la Afectación -->
                            <div class="row" id="nuevaSolicDescripcionAfectacionContainer" style="display: none;">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Descripción de la afectación <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="nuevaSolicDescripcionAfectacion" name="descripcionAfectacion" rows="2" placeholder="Describa la afectación identificada..."></textarea>
                                        <small class="form-text text-muted">Obligatorio cuando se selecciona alguna afectación</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección: Archivos Adjuntos -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-paperclip mr-2"></i>Archivos Adjuntos</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group mb-0">
                                        <label class="text-muted small mb-1">Carga de archivo</label>
                                        <div class="custom-file">
                                            <input type="file" class="custom-file-input" id="nuevaSolicAdjunto" name="adjunto" accept=".pdf,.doc,.docx,.xls,.xlsx">
                                            <label class="custom-file-label" for="nuevaSolicAdjunto">Seleccionar archivo...</label>
                                        </div>
                                        <small class="form-text text-muted">Formatos permitidos: PDF, Word, Excel</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                        </form>
                    </div>

                    <!-- Tab: Aprobadores -->
                    <div class="tab-pane fade" id="aprobadores" role="tabpanel" aria-labelledby="aprobadores-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Configuración de Aprobadores:</strong> Busque y seleccione las personas que deben aprobar esta solicitud.
                        </div>

                        <div class="row">
                            <!-- Panel Izquierdo: Búsqueda y Lista de Aprobadores Disponibles -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-primary"><i class="fas fa-search mr-2"></i>Buscar Aprobadores</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Buscador -->
                                        <div class="form-group">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="buscarAprobadores" placeholder="Buscar por nombre o cargo...">
                                                <div class="input-group-append">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarAprobadores()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Lista de Últimos Aprobadores Utilizados -->
                                        <div class="mb-2">
                                            <small class="text-muted">Últimos aprobadores utilizados:</small>
                                        </div>
                                        <div id="listaAprobadoresDisponibles" class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                            <!-- Se llenará dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel Derecho: Aprobadores Seleccionados -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white py-2">
                                        <h6 class="mb-0"><i class="fas fa-user-check mr-2"></i>Aprobadores Seleccionados</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Lista de Aprobadores Seleccionados -->
                                        <div class="mb-2">
                                            <small class="text-muted">Lista de aprobación (<span id="contadorAprobadores">0</span>):</small>
                                        </div>
                                        <div id="listaAprobadoresSeleccionados" class="border rounded p-2" style="height: 300px; overflow-y: auto;">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-users fa-2x mb-2"></i>
                                                <p>No hay aprobadores seleccionados</p>
                                                <small>Seleccione aprobadores de la lista de la izquierda</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Lista de Distribución -->
                    <div class="tab-pane fade" id="distribucion" role="tabpanel" aria-labelledby="distribucion-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Lista de Distribución:</strong> Seleccione las personas que recibirán notificaciones sobre esta solicitud.
                        </div>

                        <div class="row">
                            <!-- Panel Izquierdo: Búsqueda y Lista de Usuarios Disponibles -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0 text-primary"><i class="fas fa-search mr-2"></i>Buscar Usuarios</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Buscador -->
                                        <div class="form-group">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="buscarDistribucion" placeholder="Buscar por nombre o departamento...">
                                                <div class="input-group-append">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarDistribucion()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Lista de Últimos Usuarios Agregados -->
                                        <div class="mb-2">
                                            <small class="text-muted">Últimos usuarios agregados a la lista de distribución:</small>
                                        </div>
                                        <div id="listaDistribucionDisponible" class="border rounded p-2" style="height: 200px; overflow-y: auto;">
                                            <!-- Se llenará dinámicamente -->
                                        </div>

                                        <!-- Agregar Usuario Externo -->
                                        <div class="mt-3">
                                            <h6 class="text-primary"><i class="fas fa-user-plus mr-2"></i>Agregar Usuario Externo</h6>
                                            <div class="form-group">
                                                <label class="text-muted small mb-1">Nombre completo</label>
                                                <input type="text" class="form-control" id="nombreExterno" placeholder="Ej: Juan Pérez">
                                            </div>
                                            <div class="form-group">
                                                <label class="text-muted small mb-1">Correo electrónico</label>
                                                <input type="email" class="form-control" id="correoExterno" placeholder="Ej: juan.perez@empresa.com">
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarUsuarioExterno()">
                                                <i class="fas fa-plus mr-1"></i>Agregar a Lista
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Panel Derecho: Lista de Distribución Seleccionada -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white py-2">
                                        <h6 class="mb-0"><i class="fas fa-share-alt mr-2"></i>Lista de Distribución</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Lista de Distribución Seleccionada -->
                                        <div class="mb-2">
                                            <small class="text-muted">Usuarios en lista (<span id="contadorDistribucion">0</span>):</small>
                                        </div>
                                        <div id="listaDistribucionSeleccionada" class="border rounded p-2" style="height: 350px; overflow-y: auto;">
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-envelope fa-2x mb-2"></i>
                                                <p>No hay usuarios en la lista</p>
                                                <small>Seleccione usuarios de la lista de la izquierda</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarSolicitud()">
                    <i class="fas fa-save mr-2"></i>Guardar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script para lógica del formulario y gestión de aprobadores/distribución -->
<script>
// Variables globales para gestión de listas - usar GEME_GLOBALS para evitar conflictos
// Asegurar que GEME_GLOBALS existe
if (typeof window.GEME_GLOBALS === 'undefined') {
    window.GEME_GLOBALS = {
        aprobadoresDisponibles: [],
        aprobadoresSeleccionados: [],
        distribucionDisponible: [],
        distribucionSeleccionada: [],
        initialized: false
    };
}

// Referencias locales a las variables globales (sin redeclarar)
var aprobadoresDisponibles = window.GEME_GLOBALS.aprobadoresDisponibles;
var aprobadoresSeleccionados = window.GEME_GLOBALS.aprobadoresSeleccionados;
var distribucionDisponible = window.GEME_GLOBALS.distribucionDisponible;
var distribucionSeleccionada = window.GEME_GLOBALS.distribucionSeleccionada;

$(document).ready(function() {
    // Inicializar datos
    inicializarAprobadores();
    inicializarDistribucion();
    
    // Lógica condicional para DESCRIPCION_RIESGO
    $('#nuevaSolicRiesgo').on('change', function() {
        const riesgo = $(this).val();
        const textarea = $('#nuevaSolicDescripcionRiesgo');
        
        if (riesgo && riesgo !== '') {
            textarea.prop('required', true);
        } else {
            textarea.prop('required', false);
        }
    });
    
    // Lógica condicional para DESCRIPCION_AFECTACION
    $('#nuevaSolicAfectaciones').on('change', function() {
        const afectacion = $(this).val();
        const container = $('#nuevaSolicDescripcionAfectacionContainer');
        const textarea = $('#nuevaSolicDescripcionAfectacion');
        
        if (afectacion && afectacion !== '') {
            container.slideDown(300);
            textarea.prop('required', true);
        } else {
            container.slideUp(300);
            textarea.prop('required', false);
            textarea.val('');
        }
    });
    
    // Eventos de tabs principales
    $('#aprobadores-tab').on('shown.bs.tab', function() {
        cargarAprobadoresDisponibles();
        $('#buscarAprobadores').focus();
    });
    
    $('#distribucion-tab').on('shown.bs.tab', function() {
        cargarDistribucionDisponible();
        $('#buscarDistribucion').focus();
    });
    
    // Búsqueda en tiempo real
    $('#buscarAprobadores').on('input', function() {
        filtrarAprobadores($(this).val());
    });
    
    $('#buscarDistribucion').on('input', function() {
        filtrarDistribucion($(this).val());
    });
    
    // Limpiar todo al cerrar el modal
    $('#modalNuevaSolicitudSolic').on('hidden.bs.modal', function() {
        limpiarFormulario();
    });
});

// Inicializar datos de aprobadores
function inicializarAprobadores() {
    // Solo inicializar si no están ya inicializados
    if (window.GEME_GLOBALS.aprobadoresDisponibles.length === 0) {
        window.GEME_GLOBALS.aprobadoresDisponibles = [
        {id: 1, nombre: 'Juan Pérez', cargo: 'Administrador Senior', email: 'juan.perez@empresa.com', departamento: 'Administración'},
        {id: 2, nombre: 'María González', cargo: 'Jefe de Operaciones', email: 'maria.gonzalez@empresa.com', departamento: 'Operaciones'},
        {id: 3, nombre: 'Carlos Rodríguez', cargo: 'Supervisor Técnico', email: 'carlos.rodriguez@empresa.com', departamento: 'Técnico'},
        {id: 4, nombre: 'Ana López', cargo: 'Coordinadora de Mantenimiento', email: 'ana.lopez@empresa.com', departamento: 'Mantenimiento'},
        {id: 5, nombre: 'Roberto Silva', cargo: 'Supervisor de Turno', email: 'roberto.silva@empresa.com', departamento: 'Operaciones'},
        {id: 6, nombre: 'Patricia Morales', cargo: 'Jefe de Área', email: 'patricia.morales@empresa.com', departamento: 'Administración'},
        {id: 7, nombre: 'Diego Fernández', cargo: 'Coordinador Operativo', email: 'diego.fernandez@empresa.com', departamento: 'Operaciones'},
        {id: 8, nombre: 'Lucía Castro', cargo: 'Especialista Senior', email: 'lucia.castro@empresa.com', departamento: 'Técnico'},
        {id: 9, nombre: 'Miguel Torres', cargo: 'Técnico Especialista', email: 'miguel.torres@empresa.com', departamento: 'Técnico'},
        {id: 10, nombre: 'Carmen Ruiz', cargo: 'Ingeniera de Procesos', email: 'carmen.ruiz@empresa.com', departamento: 'Ingeniería'}
        ];
    }
    // Actualizar referencia local
    aprobadoresDisponibles = window.GEME_GLOBALS.aprobadoresDisponibles;
}

// Inicializar datos de distribución
function inicializarDistribucion() {
    // Solo inicializar si no están ya inicializados
    if (window.GEME_GLOBALS.distribucionDisponible.length === 0) {
        window.GEME_GLOBALS.distribucionDisponible = [
        {id: 1, nombre: 'Elena Vargas', cargo: 'Coordinadora General', email: 'elena.vargas@empresa.com', departamento: 'Coordinación'},
        {id: 2, nombre: 'Ricardo Jiménez', cargo: 'Jefe de Planificación', email: 'ricardo.jimenez@empresa.com', departamento: 'Planificación'},
        {id: 3, nombre: 'Mónica Delgado', cargo: 'Supervisora de Operaciones', email: 'monica.delgado@empresa.com', departamento: 'Operaciones'},
        {id: 4, nombre: 'Alejandro Ramos', cargo: 'Coordinador de Mantenimiento', email: 'alejandro.ramos@empresa.com', departamento: 'Mantenimiento'},
        {id: 5, nombre: 'Valeria Ortiz', cargo: 'Analista de Procesos', email: 'valeria.ortiz@empresa.com', departamento: 'Análisis'},
        {id: 6, nombre: 'Fernando Vega', cargo: 'Analista Técnico', email: 'fernando.vega@empresa.com', departamento: 'Técnico'},
        {id: 7, nombre: 'Sofía Herrera', cargo: 'Coordinadora de Calidad', email: 'sofia.herrera@empresa.com', departamento: 'Calidad'},
        {id: 8, nombre: 'Andrés Mendoza', cargo: 'Supervisor de Seguridad', email: 'andres.mendoza@empresa.com', departamento: 'Seguridad'},
        {id: 9, nombre: 'Departamento de Informática', cargo: 'Equipo IT', email: 'informatica@empresa.com', departamento: 'Informática'},
        {id: 10, nombre: 'Recursos Humanos', cargo: 'Equipo RRHH', email: 'rrhh@empresa.com', departamento: 'RRHH'}
        ];
    }
    // Actualizar referencia local
    distribucionDisponible = window.GEME_GLOBALS.distribucionDisponible;
}

// Cargar últimos aprobadores utilizados
function cargarAprobadoresDisponibles() {
    const container = $('#listaAprobadoresDisponibles');
    container.empty();
    
    // Simular "últimos utilizados" - mostrar los primeros 5 como más utilizados
    const ultimosUtilizados = aprobadoresDisponibles.slice(0, 5).filter(a => 
        !aprobadoresSeleccionados.find(s => s.id === a.id)
    );
    
    if (ultimosUtilizados.length === 0) {
        container.html('<div class="text-center text-muted py-3"><i class="fas fa-users-slash"></i><br>No hay aprobadores recientes disponibles</div>');
        return;
    }
    
    ultimosUtilizados.forEach(aprobador => {
        const item = $(`
            <div class="border-bottom py-2 aprobador-item" data-id="${aprobador.id}" style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${aprobador.nombre}</strong>
                        <br><small class="text-muted">${aprobador.cargo}</small>
                        <br><small class="text-info">${aprobador.email}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="agregarAprobador(${aprobador.id})">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `);
        container.append(item);
    });
}

// Cargar últimos usuarios agregados a distribución
function cargarDistribucionDisponible() {
    const container = $('#listaDistribucionDisponible');
    container.empty();
    
    // Simular "últimos agregados" - mostrar los primeros 5 como más utilizados
    const ultimosAgregados = distribucionDisponible.slice(0, 5).filter(d => 
        !distribucionSeleccionada.find(s => s.id === d.id)
    );
    
    if (ultimosAgregados.length === 0) {
        container.html('<div class="text-center text-muted py-3"><i class="fas fa-users-slash"></i><br>No hay usuarios recientes disponibles</div>');
        return;
    }
    
    ultimosAgregados.forEach(usuario => {
        const item = $(`
            <div class="border-bottom py-2 distribucion-item" data-id="${usuario.id}" style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${usuario.nombre}</strong>
                        <br><small class="text-info">${usuario.email}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-info" onclick="agregarDistribucion(${usuario.id})">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `);
        container.append(item);
    });
}

// Filtrar aprobadores
function filtrarAprobadores(termino) {
    const container = $('#listaAprobadoresDisponibles');
    const aprobadoresFiltrados = aprobadoresDisponibles.filter(a => {
        const coincide = a.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                        a.cargo.toLowerCase().includes(termino.toLowerCase()) ||
                        a.email.toLowerCase().includes(termino.toLowerCase());
        return coincide && !aprobadoresSeleccionados.find(s => s.id === a.id);
    });
    
    container.empty();
    
    if (aprobadoresFiltrados.length === 0) {
        container.html('<div class="text-center text-muted py-3"><i class="fas fa-search"></i><br>No se encontraron resultados</div>');
        return;
    }
    
    aprobadoresFiltrados.forEach(aprobador => {
        const item = $(`
            <div class="border-bottom py-2 aprobador-item" data-id="${aprobador.id}" style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${aprobador.nombre}</strong>
                        <br><small class="text-muted">${aprobador.cargo}</small>
                        <br><small class="text-info">${aprobador.email}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="agregarAprobador(${aprobador.id})">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `);
        container.append(item);
    });
}

// Filtrar distribución
function filtrarDistribucion(termino) {
    const container = $('#listaDistribucionDisponible');
    const distribucionFiltrada = distribucionDisponible.filter(d => {
        const coincide = d.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                        d.cargo.toLowerCase().includes(termino.toLowerCase()) ||
                        d.email.toLowerCase().includes(termino.toLowerCase()) ||
                        d.departamento.toLowerCase().includes(termino.toLowerCase());
        return coincide && !distribucionSeleccionada.find(s => s.id === d.id);
    });
    
    container.empty();
    
    if (distribucionFiltrada.length === 0) {
        container.html('<div class="text-center text-muted py-3"><i class="fas fa-search"></i><br>No se encontraron resultados</div>');
        return;
    }
    
    distribucionFiltrada.forEach(usuario => {
        const item = $(`
            <div class="border-bottom py-2 distribucion-item" data-id="${usuario.id}" style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${usuario.nombre}</strong>
                        <br><small class="text-info">${usuario.email}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-info" onclick="agregarDistribucion(${usuario.id})">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `);
        container.append(item);
    });
}

// Agregar aprobador
function agregarAprobador(id) {
    const aprobador = aprobadoresDisponibles.find(a => a.id === id);
    if (aprobador && !aprobadoresSeleccionados.find(s => s.id === id)) {
        aprobadoresSeleccionados.push(aprobador);
        actualizarListaAprobadoresSeleccionados();
        actualizarAlertasConfiguracion();
        cargarAprobadoresDisponibles();
        filtrarAprobadores($('#buscarAprobadores').val());
    }
}

// Remover aprobador
function removerAprobador(id) {
    aprobadoresSeleccionados = aprobadoresSeleccionados.filter(a => a.id !== id);
    actualizarListaAprobadoresSeleccionados();
    actualizarAlertasConfiguracion();
    cargarAprobadoresDisponibles();
    filtrarAprobadores($('#buscarAprobadores').val());
}

// Agregar a distribución
function agregarDistribucion(id) {
    const usuario = distribucionDisponible.find(d => d.id === id);
    if (usuario && !distribucionSeleccionada.find(s => s.id === id)) {
        distribucionSeleccionada.push(usuario);
        actualizarListaDistribucionSeleccionada();
        actualizarAlertasConfiguracion();
        cargarDistribucionDisponible();
        filtrarDistribucion($('#buscarDistribucion').val());
    }
}

// Remover de distribución
function removerDistribucion(id) {
    distribucionSeleccionada = distribucionSeleccionada.filter(d => d.id !== id);
    actualizarListaDistribucionSeleccionada();
    actualizarAlertasConfiguracion();
    cargarDistribucionDisponible();
    filtrarDistribucion($('#buscarDistribucion').val());
}

// Actualizar lista de aprobadores seleccionados
function actualizarListaAprobadoresSeleccionados() {
    const container = $('#listaAprobadoresSeleccionados');
    const contador = $('#contadorAprobadores');
    
    contador.text(aprobadoresSeleccionados.length);
    
    if (aprobadoresSeleccionados.length === 0) {
        container.html(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>No hay aprobadores seleccionados</p>
                <small>Seleccione aprobadores de la lista de la izquierda</small>
            </div>
        `);
        return;
    }
    
    container.empty();
    aprobadoresSeleccionados.forEach((aprobador, index) => {
        const item = $(`
            <div class="border-bottom py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge badge-primary mr-2">${index + 1}</span>
                        <strong>${aprobador.nombre}</strong>
                        <br><small class="text-muted ml-4">${aprobador.cargo}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removerAprobador(${aprobador.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `);
        container.append(item);
    });
}

// Actualizar lista de distribución seleccionada
function actualizarListaDistribucionSeleccionada() {
    const container = $('#listaDistribucionSeleccionada');
    const contador = $('#contadorDistribucion');
    
    contador.text(distribucionSeleccionada.length);
    
    if (distribucionSeleccionada.length === 0) {
        container.html(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-envelope fa-2x mb-2"></i>
                <p>No hay usuarios en la lista</p>
                <small>Seleccione usuarios de la lista de la izquierda</small>
            </div>
        `);
        return;
    }
    
    container.empty();
    distribucionSeleccionada.forEach(usuario => {
        const esExterno = usuario.id > 1000; // IDs > 1000 son externos
        const item = $(`
            <div class="border-bottom py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${usuario.nombre}</strong>
                        ${esExterno ? '<span class="badge badge-warning ml-2">Externo</span>' : ''}
                        <br><small class="text-info">${usuario.email}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removerDistribucion(${usuario.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `);
        container.append(item);
    });
}

// Agregar usuario externo
function agregarUsuarioExterno() {
    const nombre = $('#nombreExterno').val().trim();
    const correo = $('#correoExterno').val().trim();
    
    if (!nombre || !correo) {
        alert('Por favor complete nombre y correo electrónico');
        return;
    }
    
    // Validar formato de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(correo)) {
        alert('Por favor ingrese un correo electrónico válido');
        return;
    }
    
    // Verificar si ya existe
    if (distribucionSeleccionada.find(d => d.email.toLowerCase() === correo.toLowerCase())) {
        alert('Este correo ya está en la lista de distribución');
        return;
    }
    
    // Crear usuario externo con ID único
    const usuarioExterno = {
        id: 1000 + distribucionSeleccionada.filter(d => d.id > 1000).length + 1,
        nombre: nombre,
        cargo: 'Usuario Externo',
        email: correo,
        departamento: 'Externo'
    };
    
    distribucionSeleccionada.push(usuarioExterno);
    actualizarListaDistribucionSeleccionada();
    actualizarAlertasConfiguracion();
    
    // Limpiar campos
    $('#nombreExterno').val('');
    $('#correoExterno').val('');
}

// Funciones de búsqueda (para compatibilidad con botones)
function buscarAprobadores() {
    filtrarAprobadores($('#buscarAprobadores').val());
}

function buscarDistribucion() {
    filtrarDistribucion($('#buscarDistribucion').val());
}

// Limpiar formulario completo
function limpiarFormulario() {
    // Resetear a primer tab
    $('#mainTabs a[href="#formulario"]').tab('show');
    
    // Limpiar campos del formulario
    $('#formNuevaSolicitud')[0].reset();
    $('#nuevaSolicDescripcionRiesgo').prop('required', true);
    $('#nuevaSolicDescripcionAfectacionContainer').hide();
    $('#nuevaSolicDescripcionAfectacion').prop('required', false);
    
    // Limpiar listas de aprobadores y distribución
    aprobadoresSeleccionados = [];
    distribucionSeleccionada = [];
    
    // Limpiar campos de búsqueda
    $('#buscarAprobadores').val('');
    $('#buscarDistribucion').val('');
    $('#nombreExterno').val('');
    $('#correoExterno').val('');
    
    // No hay checkboxes que resetear en distribución
    
    // Actualizar vistas
    actualizarListaAprobadoresSeleccionados();
    actualizarListaDistribucionSeleccionada();
    
    // Resetear checkboxes de configuración
    $('#requiereAprobadores').prop('checked', false);
    $('#requiereDistribucion').prop('checked', false);
    $('#alertaAprobadores').addClass('d-none');
    $('#alertaDistribucion').addClass('d-none');
    
    // Deshabilitar tabs y resetear mensajes
    $('#aprobadores-tab').addClass('disabled')
                        .attr('tabindex', '-1')
                        .attr('aria-disabled', 'true')
                        .find('small').text('Marque "Requiere Aprobadores" para habilitar');
    
    $('#distribucion-tab').addClass('disabled')
                         .attr('tabindex', '-1')
                         .attr('aria-disabled', 'true')
                         .find('small').text('Marque "Requiere Distribución" para habilitar');
    
    // Resetear estado mostrado
    actualizarEstadoPorDefecto();
}

// ============================================
// FUNCIONES PARA CHECKBOXES DE CONFIGURACIÓN
// ============================================

// Toggle para checkbox de aprobadores
function toggleRequiereAprobadores() {
    const requiere = $('#requiereAprobadores').is(':checked');
    const alertaAprobadores = $('#alertaAprobadores');
    const tabAprobadores = $('#aprobadores-tab');
    
    if (requiere) {
        // Habilitar tab de aprobadores
        tabAprobadores.removeClass('disabled')
                     .removeAttr('tabindex')
                     .removeAttr('aria-disabled')
                     .find('small').text('Configurar aprobadores para la solicitud');
        
        // Si se marca, mostrar alerta si no hay aprobadores configurados
        if (GEME_GLOBALS.aprobadoresSeleccionados.length === 0) {
            alertaAprobadores.removeClass('d-none');
        } else {
            alertaAprobadores.addClass('d-none');
        }
        
        // Actualizar estado mostrado
        actualizarEstadoPorDefecto();
    } else {
        // Deshabilitar tab de aprobadores
        tabAprobadores.addClass('disabled')
                     .attr('tabindex', '-1')
                     .attr('aria-disabled', 'true')
                     .find('small').text('Marque "Requiere Aprobadores" para habilitar');
        
        // Volver al tab de formulario si estaba en aprobadores
        if ($('#aprobadores').hasClass('show')) {
            $('#mainTabs a[href="#formulario"]').tab('show');
        }
        
        // Ocultar alerta
        alertaAprobadores.addClass('d-none');
        
        // Actualizar estado mostrado
        actualizarEstadoPorDefecto();
    }
}

// Toggle para checkbox de distribución
function toggleRequiereDistribucion() {
    const requiere = $('#requiereDistribucion').is(':checked');
    const alertaDistribucion = $('#alertaDistribucion');
    const tabDistribucion = $('#distribucion-tab');
    
    if (requiere) {
        // Habilitar tab de distribución
        tabDistribucion.removeClass('disabled')
                      .removeAttr('tabindex')
                      .removeAttr('aria-disabled')
                      .find('small').text('Configurar lista de distribución para notificaciones');
        
        // Si se marca, mostrar alerta si no hay distribución configurada
        if (GEME_GLOBALS.distribucionSeleccionada.length === 0) {
            alertaDistribucion.removeClass('d-none');
        } else {
            alertaDistribucion.addClass('d-none');
        }
    } else {
        // Deshabilitar tab de distribución
        tabDistribucion.addClass('disabled')
                      .attr('tabindex', '-1')
                      .attr('aria-disabled', 'true')
                      .find('small').text('Marque "Requiere Distribución" para habilitar');
        
        // Volver al tab de formulario si estaba en distribución
        if ($('#distribucion').hasClass('show')) {
            $('#mainTabs a[href="#formulario"]').tab('show');
        }
        
        // Ocultar alerta
        alertaDistribucion.addClass('d-none');
    }
}

// Función para actualizar el estado por defecto mostrado
function actualizarEstadoPorDefecto() {
    const requiereAprobadores = $('#requiereAprobadores').is(':checked');
    const estadoBadge = $('#estadoPorDefecto');
    const descripcionEstado = $('#descripcionEstado');
    
    if (requiereAprobadores) {
        // Cambiar a "Por Aprobar"
        estadoBadge.removeClass('badge-warning')
                   .addClass('badge-info')
                   .text('Por Aprobar');
        
        descripcionEstado.text('La solicitud requerirá aprobación antes de continuar el proceso');
    } else {
        // Volver a "Pendiente"
        estadoBadge.removeClass('badge-info')
                   .addClass('badge-warning')
                   .text('Pendiente');
        
        descripcionEstado.text('Las solicitudes creadas por el solicitante inician en este estado');
    }
}

// Función para validar configuración antes de guardar
function validarConfiguracionAprobacion() {
    const requiereAprobadores = $('#requiereAprobadores').is(':checked');
    const requiereDistribucion = $('#requiereDistribucion').is(':checked');
    let errores = [];
    
    // Validar aprobadores si es requerido
    if (requiereAprobadores && GEME_GLOBALS.aprobadoresSeleccionados.length === 0) {
        errores.push('Debe configurar al menos un aprobador');
        $('#alertaAprobadores').removeClass('d-none');
    } else {
        $('#alertaAprobadores').addClass('d-none');
    }
    
    // Validar distribución si es requerida
    if (requiereDistribucion && GEME_GLOBALS.distribucionSeleccionada.length === 0) {
        errores.push('Debe configurar al menos un usuario en la lista de distribución');
        $('#alertaDistribucion').removeClass('d-none');
    } else {
        $('#alertaDistribucion').addClass('d-none');
    }
    
    return errores;
}

// Función para guardar solicitud con validaciones
function guardarSolicitud() {
    console.log('Guardando nueva solicitud...');
    
    // Validar formulario básico
    const form = document.getElementById('formNuevaSolicitud');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Validar configuración de aprobación
    const erroresConfiguracion = validarConfiguracionAprobacion();
    if (erroresConfiguracion.length > 0) {
        alert('Error de configuración:\n\n' + erroresConfiguracion.join('\n') + '\n\nPor favor, complete la configuración requerida antes de guardar.');
        return;
    }
    
    // Recopilar datos del formulario
    const datosFormulario = {
        // Datos básicos
        idSolicitud: $('#nuevaSolicIDSolicitud').val(),
        tipoTrabajo: $('#nuevaSolicTipo').val(),
        relacionSODICEN: $('#nuevaSolicRelacionSODICEN').val(),
        inicioProgramado: $('#nuevaSolicInicioProgramado').val(),
        finProgramado: $('#nuevaSolicFinProgramado').val(),
        empresaSolicitante: $('#nuevaSolicEmpresaSolicitante').val(),
        empresaReceptora: $('#nuevaSolicEmpresaReceptora').val(),
        instalacionGM: $('#nuevaSolicInstalacionGM').val(),
        equipos: $('#nuevaSolicEquipos').val(),
        descripcionTrabajo: $('#nuevaSolicDescripcionTrabajo').val(),
        riesgo: $('#nuevaSolicRiesgo').val(),
        afectaciones: $('#nuevaSolicAfectaciones').val(),
        descripcionRiesgo: $('#nuevaSolicDescripcionRiesgo').val(),
        descripcionAfectacion: $('#nuevaSolicDescripcionAfectacion').val(),
        
        // Configuración de aprobación
        requiereAprobadores: $('#requiereAprobadores').is(':checked'),
        requiereDistribucion: $('#requiereDistribucion').is(':checked'),
        aprobadores: GEME_GLOBALS.aprobadoresSeleccionados,
        distribucion: GEME_GLOBALS.distribucionSeleccionada,
        
        // Metadata
        solicitante: 'Demo Novakem 10',
        fechaCreacion: new Date().toISOString(),
        estado: datosFormulario.requiereAprobadores ? 'Por Aprobar' : 'Pendiente'
    };
    
    console.log('Datos de la solicitud:', datosFormulario);
    
    // Aquí se enviarían los datos al servidor
    // Por ahora, mostrar mensaje de confirmación
    let mensaje = '✅ Solicitud guardada exitosamente!\n\n';
    mensaje += `ID: ${datosFormulario.idSolicitud}\n`;
    mensaje += `Tipo: ${datosFormulario.tipoTrabajo}\n`;
    mensaje += `Estado: ${datosFormulario.estado}\n\n`;
    
    // Mensaje específico según el estado
    if (datosFormulario.estado === 'Por Aprobar') {
        mensaje += `🔍 La solicitud requiere aprobación y ha sido enviada a los aprobadores configurados.\n`;
        mensaje += `📋 Aprobadores: ${datosFormulario.aprobadores.length} configurados\n`;
        mensaje += `⏳ Próximo paso: Los aprobadores revisarán y tomarán una decisión sobre la solicitud.\n\n`;
    } else {
        mensaje += `📋 La solicitud no requiere aprobación previa y pasa directamente al proceso de análisis.\n`;
        mensaje += `⏳ Próximo paso: El administrador revisará la solicitud.\n\n`;
    }
    
    if (datosFormulario.requiereDistribucion) {
        mensaje += `📧 Lista de distribución: ${datosFormulario.distribucion.length} usuarios serán notificados\n`;
    }
    
    alert(mensaje);
    
    // Cerrar modal y limpiar formulario
    $('#modalNuevaSolicitud').modal('hide');
    setTimeout(() => {
        limpiarFormulario();
    }, 500);
}

// Actualizar alertas cuando cambian las listas
function actualizarAlertasConfiguracion() {
    // Actualizar alerta de aprobadores
    if ($('#requiereAprobadores').is(':checked')) {
        if (GEME_GLOBALS.aprobadoresSeleccionados.length > 0) {
            $('#alertaAprobadores').addClass('d-none');
        } else {
            $('#alertaAprobadores').removeClass('d-none');
        }
    }
    
    // Actualizar alerta de distribución
    if ($('#requiereDistribucion').is(':checked')) {
        if (GEME_GLOBALS.distribucionSeleccionada.length > 0) {
            $('#alertaDistribucion').addClass('d-none');
        } else {
            $('#alertaDistribucion').removeClass('d-none');
        }
    }
}
</script>
