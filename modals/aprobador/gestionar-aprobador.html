<!-- MODAL GESTIONAR SOLICITUD APROBADOR - Para solicitudes POR APROBAR -->
<div class="modal fade" id="modalGestionarSolicitudAprobador" tabindex="-1" role="dialog" aria-labelledby="modalGestionarSolicitudAprobadorLabel" aria-hidden="true" data-backdrop="true" data-keyboard="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalGestionarSolicitudAprobadorLabel">
                    <i class="fas fa-clipboard-check mr-2"></i>Gestionar Solicitud Por Aprobar
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tabs Navigation Principal -->
                <ul class="nav nav-tabs nav-justified mb-4" id="gestionarAprobMainTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="gestionarAprob-solicitud-tab" data-toggle="tab" href="#gestionarAprob-solicitud" role="tab" aria-controls="gestionarAprob-solicitud" aria-selected="true">
                            <i class="fas fa-file-alt mr-2"></i>Detalle de Solicitud
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="gestionarAprob-decision-tab" data-toggle="tab" href="#gestionarAprob-decision" role="tab" aria-controls="gestionarAprob-decision" aria-selected="false">
                            <i class="fas fa-gavel mr-2"></i>Decisión de Aprobación
                        </a>
                    </li>
                </ul>

                <!-- Tabs Content Principal -->
                <div class="tab-content" id="gestionarAprobMainTabsContent">
                    <!-- Tab: Detalle de Solicitud -->
                    <div class="tab-pane fade show active" id="gestionarAprob-solicitud" role="tabpanel" aria-labelledby="gestionarAprob-solicitud-tab">
                        <div class="alert alert-info mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-shield mr-3 fa-2x"></i>
                                <div>
                                    <strong>Rol: Aprobador</strong><br>
                                    <small>Como aprobador, debe revisar y tomar una decisión sobre esta solicitud en estado "Por Aprobar".</small>
                                </div>
                            </div>
                        </div>

                        <!-- Header: Estado y Observaciones -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-info-circle mr-2"></i>Estado y Observaciones</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="alert alert-info mb-0 d-flex align-items-center" role="alert">
                                            <i class="fas fa-circle mr-2"></i>
                                            <div>
                                                <strong>Estado:</strong> <span class="badge badge-info ml-2">Por Aprobar</span>
                                                <small class="d-block mt-1 text-muted">La solicitud está pendiente de aprobación</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1"><strong>Observaciones del Administrador:</strong></label>
                                            <p class="mb-0" id="gestionarAprobObservacionesHeader">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Identificación (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-id-card mr-2"></i>Identificación</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">ID Solicitud</label>
                                            <input type="text" class="form-control" id="gestionarAprobIDSolicitud" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Tipo de Trabajo</label>
                                            <input type="text" class="form-control" id="gestionarAprobTipo" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Relación SODI-CEN</label>
                                            <input type="text" class="form-control" id="gestionarAprobRelacionSODICEN" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Fechas Programadas (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-calendar mr-2"></i>Fechas Programadas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Inicio Programado</label>
                                            <input type="text" class="form-control" id="gestionarAprobInicioProgramado" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Fin Programado</label>
                                            <input type="text" class="form-control" id="gestionarAprobFinProgramado" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Empresas Involucradas (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-building mr-2"></i>Empresas Involucradas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Empresa Solicitante</label>
                                            <input type="text" class="form-control" id="gestionarAprobEmpresaSolicitante" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Empresa Receptora</label>
                                            <input type="text" class="form-control" id="gestionarAprobEmpresaReceptora" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Instalación y Equipos (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-cogs mr-2"></i>Instalación y Equipos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Instalación GM</label>
                                            <input type="text" class="form-control" id="gestionarAprobInstalacionGM" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Equipos Involucrados</label>
                                            <textarea class="form-control" id="gestionarAprobEquipos" rows="2" readonly></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Descripción del Trabajo (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-clipboard mr-2"></i>Descripción del Trabajo</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Descripción del Trabajo</label>
                                            <textarea class="form-control" id="gestionarAprobDescripcionTrabajo" rows="4" readonly></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Riesgos y Afectaciones (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-exclamation-triangle mr-2"></i>Riesgos y Afectaciones</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Riesgo</label>
                                            <input type="text" class="form-control" id="gestionarAprobRiesgo" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Afectaciones</label>
                                            <input type="text" class="form-control" id="gestionarAprobAfectaciones" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Descripción del Riesgo</label>
                                            <textarea class="form-control" id="gestionarAprobDescripcionRiesgo" rows="2" readonly></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Descripción de Afectaciones</label>
                                            <textarea class="form-control" id="gestionarAprobDescripcionAfectacion" rows="2" readonly></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Archivo Adjunto (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-paperclip mr-2"></i>Archivo Adjunto</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Archivo Actual</label>
                                            <div>
                                                <span id="gestionarAprobAdjuntoActual" class="text-muted">-</span>
                                                <button type="button" class="btn btn-sm btn-primary ml-2" id="gestionarAprobDescargarAdjunto" style="display:none;">
                                                    <i class="fas fa-download mr-1"></i>Descargar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Metadata del Sistema (SOLO LECTURA) -->
                        <div class="card mb-3">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0 text-primary"><i class="fas fa-database mr-2"></i>Información del Sistema</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">ID Registro</label>
                                            <p class="mb-0" id="gestionarAprobIDRegistro">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Creado</label>
                                            <p class="mb-0" id="gestionarAprobCreado">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label class="text-muted small mb-1">Actualizado</label>
                                            <p class="mb-0" id="gestionarAprobActualizado">-</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Administrador</label>
                                            <p class="mb-0" id="gestionarAprobAdministrador">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Solicitante</label>
                                            <p class="mb-0" id="gestionarAprobSolicitante">-</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group mb-0">
                                            <label class="text-muted small mb-1">Creado Por</label>
                                            <p class="mb-0" id="gestionarAprobCreadoPor">-</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Detalle de Solicitud -->

                    <!-- Tab: Decisión de Aprobación -->
                    <div class="tab-pane fade" id="gestionarAprob-decision" role="tabpanel" aria-labelledby="gestionarAprob-decision-tab">
                        <div class="alert alert-warning mb-4" role="alert">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Importante:</strong> Como aprobador, debe tomar una decisión sobre esta solicitud. Su decisión será registrada y notificada al solicitante.
                        </div>

                        <!-- Sección de Decisión del Aprobador -->
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark py-2">
                                <h6 class="mb-0"><i class="fas fa-gavel mr-2"></i>Decisión de Aprobación</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="font-weight-bold">Seleccione la acción a realizar: <span class="text-danger">*</span></label>
                                    <div class="mt-2">
                                        <div class="custom-control custom-radio mb-2">
                                            <input type="radio" id="aprobadorAccionAprobar" name="aprobadorAccion" value="aprobar" class="custom-control-input">
                                            <label class="custom-control-label" for="aprobadorAccionAprobar">
                                                <i class="fas fa-check-circle text-success mr-2"></i>
                                                <strong>Aprobar Solicitud</strong> → En Análisis
                                                <small class="d-block text-muted ml-4">La solicitud continuará el proceso normal de revisión técnica</small>
                                            </label>
                                        </div>
                                        <div class="custom-control custom-radio mb-2">
                                            <input type="radio" id="aprobadorAccionDevolver" name="aprobadorAccion" value="devolver" class="custom-control-input">
                                            <label class="custom-control-label" for="aprobadorAccionDevolver">
                                                <i class="fas fa-undo text-warning mr-2"></i>
                                                <strong>Devolver Solicitud</strong> → Devuelta
                                                <small class="d-block text-muted ml-4">El solicitante podrá realizar correcciones según sus comentarios</small>
                                            </label>
                                        </div>
                                        <div class="custom-control custom-radio mb-2">
                                            <input type="radio" id="aprobadorAccionAnular" name="aprobadorAccion" value="anular" class="custom-control-input">
                                            <label class="custom-control-label" for="aprobadorAccionAnular">
                                                <i class="fas fa-times-circle text-danger mr-2"></i>
                                                <strong>Anular Solicitud</strong> → No Solicitada
                                                <small class="d-block text-muted ml-4">La solicitud será cancelada definitivamente</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-0">
                                    <label for="aprobadorComentarios" class="font-weight-bold">Comentarios sobre la decisión: <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="aprobadorComentarios" rows="4" 
                                        placeholder="Ingrese los motivos de su decisión. Este comentario será visible para el solicitante y administradores..." required></textarea>
                                    <small class="form-text text-muted">
                                        Los comentarios son <strong>obligatorios</strong> y deben ser descriptivos (mínimo 10 caracteres). 
                                        Ayudan a justificar la decisión tomada y proporcionan retroalimentación al solicitante.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin Tab: Decisión de Aprobación -->
                </div>
                <!-- Fin Tabs Content Principal -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmarDecisionAprobador()">
                    <i class="fas fa-gavel mr-2"></i>Confirmar Decisión
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script para lógica del modal aprobador -->
<script>
// ============================================
// FUNCIONES DEL MODAL APROBADOR
// ============================================

// Función para poblar el modal con datos de la solicitud
window.poblarModalGestionarAprobador = function(solicitud) {
    console.log('Poblando modal gestionar aprobador:', solicitud);
    
    // Header: Estado y Observaciones
    $('#gestionarAprobObservacionesHeader').text(solicitud.OBSERVACIONES || 'Sin observaciones');
    
    // Identificación
    $('#gestionarAprobIDSolicitud').val(solicitud.ID_SOLICITUD || '');
    $('#gestionarAprobTipo').val(solicitud.TIPO_TRABAJO || '');
    $('#gestionarAprobRelacionSODICEN').val(solicitud.RELACION_SODI_CEN || '');
    
    // Fechas Programadas
    $('#gestionarAprobInicioProgramado').val(solicitud.INICIO_PROGRAMADO ? formatDateTimeForDisplay(solicitud.INICIO_PROGRAMADO) : '');
    $('#gestionarAprobFinProgramado').val(solicitud.FIN_PROGRAMADO ? formatDateTimeForDisplay(solicitud.FIN_PROGRAMADO) : '');
    
    // Empresas Involucradas
    $('#gestionarAprobEmpresaSolicitante').val(solicitud.EMPRESA_SOLICITANTE || '');
    $('#gestionarAprobEmpresaReceptora').val(solicitud.EMPRESA_RECEPTORA || '');
    
    // Instalación y Equipos
    $('#gestionarAprobInstalacionGM').val(solicitud.INSTALACION_GM || '');
    $('#gestionarAprobEquipos').val(solicitud.EQUIPOS || '');
    
    // Descripción del Trabajo
    $('#gestionarAprobDescripcionTrabajo').val(solicitud.DESCRIPCION_TRABAJO || '');
    
    // Riesgos y Afectaciones
    $('#gestionarAprobRiesgo').val(solicitud.RIESGO || '');
    $('#gestionarAprobAfectaciones').val(solicitud.AFECTACIONES || '');
    $('#gestionarAprobDescripcionRiesgo').val(solicitud.DESCRIPCION_RIESGO || '');
    $('#gestionarAprobDescripcionAfectacion').val(solicitud.DESCRIPCION_AFECTACION || '');
    
    // Archivo Adjunto
    if (solicitud.ADJUNTO && solicitud.ADJUNTO !== '-') {
        $('#gestionarAprobAdjuntoActual').text(solicitud.ADJUNTO);
        $('#gestionarAprobDescargarAdjunto').show();
    } else {
        $('#gestionarAprobAdjuntoActual').text('Sin archivo adjunto');
        $('#gestionarAprobDescargarAdjunto').hide();
    }
    
    // Metadata del Sistema
    $('#gestionarAprobIDRegistro').text(solicitud.ID_REGISTRO || '-');
    $('#gestionarAprobCreado').text(solicitud.CREADO || '-');
    $('#gestionarAprobActualizado').text(solicitud.ACTUALIZADO || '-');
    $('#gestionarAprobAdministrador').text(solicitud.ADMINISTRADOR || '-');
    $('#gestionarAprobSolicitante').text(solicitud.SOLICITANTE || '-');
    $('#gestionarAprobCreadoPor').text(solicitud.CREADO_POR || '-');
    
    // Limpiar campos de decisión
    $('input[name="aprobadorAccion"]').prop('checked', false);
    $('#aprobadorComentarios').val('');
    
    // Guardar ID para posterior uso
    $('#modalGestionarSolicitudAprobador').data('solicitudId', solicitud.ID_REGISTRO);
};

// Función para confirmar la decisión del aprobador
window.confirmarDecisionAprobador = function() {
    const solicitudId = $('#modalGestionarSolicitudAprobador').data('solicitudId');
    const accion = $('input[name="aprobadorAccion"]:checked').val();
    const comentarios = $('#aprobadorComentarios').val().trim();
    
    // Validaciones
    if (!accion) {
        alert('Por favor seleccione una acción a realizar');
        $('#gestionarAprob-decision-tab').tab('show');
        return;
    }
    
    if (!comentarios) {
        alert('Por favor ingrese comentarios sobre la decisión.\nLos comentarios son obligatorios para justificar su decisión.');
        $('#aprobadorComentarios').focus();
        return;
    }
    
    if (comentarios.length < 10) {
        alert('Los comentarios deben tener al menos 10 caracteres para ser descriptivos.');
        $('#aprobadorComentarios').focus();
        return;
    }
    
    // Determinar nuevo estado y mensaje
    let nuevoEstado = '';
    let mensaje = '';
    let icono = '';
    
    switch(accion) {
        case 'aprobar':
            nuevoEstado = 'En Análisis';
            icono = '✅';
            mensaje = 'Solicitud aprobada exitosamente.\n\nLa solicitud pasa a estado "En Análisis" para continuar el proceso de revisión técnica.';
            break;
        case 'devolver':
            nuevoEstado = 'Devuelta';
            icono = '↩️';
            mensaje = 'Solicitud devuelta al solicitante.\n\nEl solicitante recibirá una notificación y podrá realizar las correcciones necesarias según sus comentarios.';
            break;
        case 'anular':
            nuevoEstado = 'No Solicitada';
            icono = '❌';
            mensaje = 'Solicitud anulada.\n\nLa solicitud ha sido marcada como "No Solicitada" y no continuará el proceso.';
            break;
    }
    
    console.log('Decisión del aprobador:', {
        solicitudId,
        accion,
        nuevoEstado,
        comentarios,
        aprobador: 'Demo Novakem 10',
        fecha: new Date().toISOString()
    });
    
    // Aquí se actualizaría el estado en la base de datos
    // Por ahora solo mostramos el mensaje de confirmación
    alert(`${icono} ${mensaje}\n\nComentarios registrados:\n"${comentarios}"\n\nAprobador: Demo Novakem 10\nFecha: ${new Date().toLocaleString()}`);
    
    // Cerrar modal
    $('#modalGestionarSolicitudAprobador').modal('hide');
    
    // Recargar vista
    setTimeout(() => {
        location.reload();
    }, 1000);
};

// Función auxiliar para formatear fechas
function formatDateTimeForDisplay(dateTimeString) {
    if (!dateTimeString) return '';
    try {
        const date = new Date(dateTimeString);
        return date.toLocaleString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return dateTimeString;
    }
}
</script>
