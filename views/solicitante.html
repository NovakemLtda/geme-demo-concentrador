<style>
    /* Asegura que los dropdowns de filtros se muestren sobre la botonera */
    #zona-filtro {
        overflow: visible;
    }

    #zona-filtro .bootstrap-select .dropdown-menu {
        z-index: 9999; /* asegurar que quede siempre sobre la botonera y otros elementos */
    }
    
    /* Forzar z-index alto para el filtro Estado */
    div[data-id="filtroEstadoSolic"] {
        position: relative !important;
        z-index: 1060 !important;
    }
    div[data-id="filtroEstadoSolic"] .dropdown-menu {
        z-index: 1061 !important;
        position: absolute !important;
    }
    
    /* Estilos para el dashboard del solicitante */
    .card-alcance {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        transition: transform 0.2s;
    }
    
    .card-alcance:hover {
        transform: translateY(-2px);
    }
    
    /* Eliminar bordes de las tarjetas en los dashboards */
    #resumen-solicitante-proceso .card,
    #resumen-solicitante-historico .card {
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Eliminar bordes internos en el dashboard hist√≥rico */
    #resumen-solicitante-historico .card-body {
        border: none !important;
    }
    
    /* Eliminar borde del contenedor de tabs */
    #dashboard-content-solic {
        border: none !important;
    }
    
    /* Eliminar bordes de los paneles de tabs */
    .tab-pane {
        border: none !important;
    }
    
    /* Mejorar espaciado */
    .card-body {
        padding: 0.75rem;
    }
    
    /* Eliminar bordes del selector */
    #filtroAnioHistoricoSolic {
        box-shadow: none;
    }
    
    /* Asegurar que los n√∫meros de los indicadores se vean en blanco */
    .card.text-white h2,
    .card.text-white h4 {
        color: white !important;
    }
</style>

<h2 class="mb-4"><i class="fas fa-file-alt"></i> Solicitudes</h2>

<!-- Dashboard con tabs para indicadores del solicitante -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <ul class="nav nav-tabs card-header-tabs" id="dashboard-tabs-solic" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active bg-white text-dark font-weight-bold" id="proceso-tab-solic" data-toggle="tab" href="#proceso-content-solic" role="tab" aria-controls="proceso-content-solic" aria-selected="true">
                            <i class="fas fa-tasks"></i> Dashboard En Proceso
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" id="historico-tab-solic" data-toggle="tab" href="#historico-content-solic" role="tab" aria-controls="historico-content-solic" aria-selected="false">
                            <i class="fas fa-history"></i> Dashboard Hist√≥rico
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="dashboard-content-solic">
                    <!-- Tab de Dashboard En Proceso -->
                    <div class="tab-pane fade show active" id="proceso-content-solic" role="tabpanel" aria-labelledby="proceso-tab-solic">
                        <div class="row" id="resumen-solicitante-proceso"></div>
                    </div>
                    
                    <!-- Tab de Dashboard Hist√≥rico -->
                    <div class="tab-pane fade" id="historico-content-solic" role="tabpanel" aria-labelledby="historico-tab-solic">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-group d-flex align-items-center border-0">
                                    <label for="filtroAnioHistoricoSolic" class="mr-2 mb-0 font-weight-bold">A√±o:</label>
                                    <select class="form-control form-control-sm border-0" id="filtroAnioHistoricoSolic" style="width: auto; min-width: 80px; max-width: 120px;" onchange="cargarDashboardHistoricoSolic()">
                                        <!-- Las opciones se cargar√°n din√°micamente -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="resumen-solicitante-historico"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumen de solicitudes del solicitante (legacy) -->
<div class="row mb-4" id="resumen-solicitante" style="display: none;"></div>

<div class="row mb-4">
    <div class="col-12">
        <div class="btn-group mt-1" id="zona-botonera-filtro" role="group" aria-label="Botonera">
            <button id="showHideFilter" class="btn btn-secondary collapsed" type="button" data-toggle="collapse" data-target="#zona-filtro" aria-expanded="false" aria-controls="zona-filtro">
                <i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i>
                Mostrar filtro
            </button>
            <button id="clearFilter" class="btn btn-outline-dark" type="button" onclick="limpiarFiltros()">
                <i class="fas fa-broom mr-2" aria-hidden="true"></i>
                <span>Limpiar filtro</span>
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card collapse" id="zona-filtro">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtros de B√∫squeda</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Instalaci√≥n GM</label>
                            <select
                                class="form-control selectpicker"
                                id="filtroInstalacionGMSolic"
                                multiple
                                data-actions-box="true"
                                data-live-search="true"
                                data-container="body"
                                data-none-selected-text="Todas las instalaciones">
                                <option value="">Todas</option>
                                <option value="Santiago Solar">Santiago Solar</option>
                                <option value="Nueva Renca">Nueva Renca</option>
                                <option value="Los Vientos">Los Vientos</option>
                                <option value="Santa Lidia">Santa Lidia</option>
                                <option value="CEME1">CEME1</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Instalaciones/Equipos a intervenir</label>
                            <input type="text" class="form-control" id="filtroEquiposSolic" placeholder="Buscar equipos...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Tipo Intervenci√≥n</label>
                            <select class="form-control" id="filtroTipoIntervencionSolic">
                                <option value="">Todos</option>
                                <option value="Intervenci√≥n">Intervenci√≥n</option>
                                <option value="Desconexi√≥n">Desconexi√≥n</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Estado</label>
                            <select
                                class="form-control selectpicker"
                                id="filtroEstadoSolic"
                                multiple
                                data-actions-box="true"
                                data-live-search="true"
                                data-container="body"
                                data-none-selected-text="Todos los estados">
                                <option value="">Todos</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Por Aprobar">Por Aprobar</option>
                                <option value="Devuelta">Devuelta</option>
                                <option value="En An√°lisis">En An√°lisis</option>
                                <option value="Administrador Gestionando">Administrador Gestionando</option>
                                <option value="Programada">Programada</option>
                                <option value="Vigente">Vigente</option>
                                <option value="Extendida">Extendida</option>
                                <option value="Finalizada">Finalizada</option>
                                <option value="No Solicitada">No Solicitada</option>
                                <option value="Rechazada">Rechazada</option>
                                <option value="Suspendida">Suspendida</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Aplica SODI</label>
                            <select class="form-control" id="filtroAplicaSODISolic">
                                <option value="">Todos</option>
                                <option value="S√≠">S√≠</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Inicio Programada Desde</label>
                            <input type="date" class="form-control" id="filtroFechaDesdeSolic">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Inicio Programada Hasta</label>
                            <input type="date" class="form-control" id="filtroFechaHastaSolic">
                        </div>
                    </div>
                </div>
                <div class="btns-accion-filtro d-flex align-items-center">
                    <a href="javascript:;" class="btn-filtrar text-decoration-none mr-3" onclick="aplicarFiltrosSolic()">
                        <i class="fas fa-filter"></i> Filtrar
                    </a>
                    <a href="javascript:;" class="btn-limpiar text-decoration-none" onclick="limpiarFiltrosSolic()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 align-items-center">
    <div class="col-lg-6">
        <div class="botonera d-flex align-items-center">
            <a class="btn btn-customized" href="javascript:;" role="button" onclick="abrirModalNuevaSolicitudSolic()" id="btn-newDoc">
                <i class="fa fa-plus"></i> Nueva Solicitud
            </a>
            <a class="btn btn-success ml-2" href="javascript:;" role="button" id="btn-descargar-excel-solic">
                <i class="fas fa-file-excel"></i> Descargar Excel Vinculado
            </a>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-12">
        <div class="row justify-content-end">
            <div class="form-group col-lg-3 col-md-3 col-sm-3 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" checked="" id="cbxEnProceso" autocomplete="off" onchange="filtrarPorEstado('proceso')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="En Proceso" autocomplete="off">
                </div>
            </div>
            <div class="form-group col-lg-3 col-md-3 col-sm-3 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" id="cbxFinalizadas" autocomplete="off" onchange="filtrarPorEstado('finalizadas')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="Finalizadas" autocomplete="off">
                </div>
            </div>
            <div class="form-group col-lg-3 col-md-3 col-sm-3 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" id="cbxTodas" autocomplete="off" onchange="filtrarPorEstado('todas')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="Todas" autocomplete="off">
                </div>
            </div>				
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="tablaSolicitudesSolicitante" class="table table-sm table-hover table-bordered w-100">
                        <thead>
                            <tr class="table-group">
                                <th class="text-center">Acciones</th>
                                <th>ID</th>
                                <th>ID CEN</th>
                                <th>Tipo de intervenci√≥n</th>
                                <th>Instalaci√≥n GM</th>
                                <th>Descripci√≥n del trabajo</th>
                                <th>Condiciones requeridas</th>
                                <th>Empresa solicitante</th>
                                <th>Empresa receptora</th>
                                <th>Fecha programada de inicio</th>
                                <th>Fecha programada de fin</th>
                                <th>Aplica SODI</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Las filas se cargan din√°micamente desde data/solicitudes.js mediante js/solicitante.js -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cambiar texto del bot√≥n al colapsar/expandir
$('#zona-filtro').on('show.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Ocultar filtro');
});

$('#zona-filtro').on('hide.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Mostrar filtro');
});

// ============================================
// CARGAR DATOS DIN√ÅMICAMENTE DESDE solicitudesData
// ============================================
(function() {
    console.log('üîÑ Cargando solicitudes del solicitante...');
    
    // Verificar que solicitudesData existe
    if (typeof solicitudesData === 'undefined') {
        console.error('‚ùå solicitudesData no est√° definido');
        setTimeout(arguments.callee, 100); // Reintentar en 100ms
        return;
    }
    
    // Filtrar solo solicitudes creadas por solicitante
    const solicitudes = solicitudesData.filter(sol => sol.CREADO_POR === 'Solicitante');
    console.log(`üìä Encontradas ${solicitudes.length} solicitudes del solicitante`);
    
    const tbody = $('#tablaSolicitudesSolicitante tbody');
    tbody.empty(); // Limpiar tabla

    // ===============================
    // Calcular indicadores para ambos dashboards
    // ===============================
    
    // Obtener fecha actual y calcular fecha en 30 d√≠as
    const ahora = new Date();
    const en30Dias = new Date();
    en30Dias.setDate(ahora.getDate() + 30);
    const anioActual = ahora.getFullYear();
    
    // Extraer a√±os √∫nicos de las solicitudes para el selector
    const aniosDisponibles = new Set();
    solicitudes.forEach(sol => {
        if (sol.CREADO) {
            const fechaCreacion = new Date(sol.CREADO);
            if (!isNaN(fechaCreacion.getTime())) {
                aniosDisponibles.add(fechaCreacion.getFullYear());
            }
        }
    });
    
    // Asegurar que siempre est√©n disponibles al menos los a√±os 2023, 2024 y 2025
    aniosDisponibles.add(2023);
    aniosDisponibles.add(2024);
    aniosDisponibles.add(2025);
    
    // Si no hay a√±os disponibles en los datos, agregar a√±os de ejemplo
    if (aniosDisponibles.size < 5) {
        // A√±adir a√±o actual y 4 a√±os anteriores como ejemplo
        aniosDisponibles.add(anioActual);
        for (let i = 1; i <= 4; i++) {
            aniosDisponibles.add(anioActual - i);
        }
    }
    
    // Ordenar a√±os de mayor a menor
    const aniosOrdenados = Array.from(aniosDisponibles).sort((a, b) => b - a);
    
    // Poblar selector de a√±os
    const selectorAnio = $('#filtroAnioHistoricoSolic');
    selectorAnio.empty();
    aniosOrdenados.forEach(anio => {
        selectorAnio.append(`<option value="${anio}"${anio === anioActual ? ' selected' : ''}>${anio}</option>`);
    });
    
    // ===============================
    // Dashboard En Proceso
    // ===============================
    
    // Indicadores para solicitudes en proceso
    const resumenProceso = {
        totalPendiente: 0,
        totalPorAprobar: 0,
        totalEnAnalisis: 0,
        totalAdminGestionando: 0,
        totalProgramada: 0,
        totalVigentes: 0,
        totalExtendida: 0,
        totalSuspendida: 0,
        sodiProgramadas: 0,
        intervencionesProgramadas: 0,
        desconexionesProgramadas: 0
    };

    solicitudes.forEach(sol => {
        const estado = sol.ESTADO;
        const tipo = sol.TIPO_TRABAJO;
        
        // Conteo por estados en proceso
        if (estado === 'Pendiente') resumenProceso.totalPendiente++;
        if (estado === 'Por Aprobar') resumenProceso.totalPorAprobar++;
        if (estado === 'En An√°lisis') resumenProceso.totalEnAnalisis++;
        if (estado === 'Administrador Gestionando') resumenProceso.totalAdminGestionando++;
        if (estado === 'Programada') resumenProceso.totalProgramada++;
        if (estado === 'Vigente') resumenProceso.totalVigentes++;
        if (estado === 'Extendida') resumenProceso.totalExtendida++;
        if (estado === 'Suspendida') resumenProceso.totalSuspendida++;
        
        // Conteo para indicadores de pr√≥ximos 30 d√≠as
        if (estado === 'Programada' && sol.INICIO_PROGRAMADO) {
            const fechaInicio = new Date(sol.INICIO_PROGRAMADO);
            if (!isNaN(fechaInicio.getTime()) && fechaInicio >= ahora && fechaInicio <= en30Dias) {
                // Clasificar seg√∫n tipo
                if (tipo === 'SODI') {
                    resumenProceso.sodiProgramadas++;
                } else if (['SICN', 'SICF'].includes(tipo)) {
                    resumenProceso.intervencionesProgramadas++;
                } else if (['SDCN', 'SDCF'].includes(tipo)) {
                    resumenProceso.desconexionesProgramadas++;
                }
            }
        }
    });

    // Generar HTML para dashboard en proceso
    let resumenProcesoHtml = '';
    
    // Indicadores de estados en proceso
    resumenProcesoHtml += `
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body py-2">
                    <small class="d-block">Pendiente
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Pendiente" data-content="Solicitudes pendientes de revisi√≥n inicial."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalPendiente}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Por Aprobar
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Por Aprobar" data-content="Solicitudes esperando aprobaci√≥n de los aprobadores asignados."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalPorAprobar}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body py-2">
                    <small class="d-block">En An√°lisis
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="En An√°lisis" data-content="Solicitudes que se encuentran en estado de an√°lisis."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalEnAnalisis}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body py-2">
                    <small class="d-block">Admin. Gestionando
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Administrador Gestionando" data-content="Solicitudes que est√°n siendo gestionadas por un administrador."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalAdminGestionando}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body py-2">
                    <small class="d-block">Programada
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Programada" data-content="Solicitudes programadas para ejecuci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalProgramada}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body py-2">
                    <small class="d-block">Vigente
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Vigente" data-content="Solicitudes actualmente vigentes seg√∫n su periodo programado."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalVigentes}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-dark h-100">
                <div class="card-body py-2">
                    <small class="d-block">Extendida
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Extendida" data-content="Solicitudes cuyo periodo de vigencia ha sido extendido."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalExtendida}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-dark h-100">
                <div class="card-body py-2">
                    <small class="d-block">Suspendida
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Suspendida" data-content="Solicitudes suspendidas temporalmente en su ejecuci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalSuspendida}</h4>
                </div>
            </div>
        </div>
    `;
    
    // Insertar HTML en el dashboard de proceso
    $('#resumen-solicitante-proceso').html(resumenProcesoHtml);
    // Inicializar popovers para los indicadores
    $('#resumen-solicitante-proceso [data-toggle="popover"]').popover();
    
    // ===============================
    // Funci√≥n para cargar Dashboard Hist√≥rico
    // ===============================
    window.cargarDashboardHistoricoSolic = function() {
        const anioSeleccionado = parseInt($('#filtroAnioHistoricoSolic').val());
        
        // Indicadores para solicitudes hist√≥ricas
        const resumenHistorico = {
            totalGeneradas: 0,
            totalSODIs: 0,
            totalCEN: 0,
            totalDevueltas: 0,
            totalAnuladas: 0,
            totalEnProceso: 0,
            totalVigentes: 0,
            totalRechazadas: 0,
            totalExtendidas: 0,
            totalSuspendidas: 0,
            totalFinalizadas: 0
        };
        
        solicitudes.forEach(sol => {
            // Verificar si la solicitud pertenece al a√±o seleccionado
            let pertenece = false;
            if (sol.CREADO) {
                const fechaCreacion = new Date(sol.CREADO);
                if (!isNaN(fechaCreacion.getTime()) && fechaCreacion.getFullYear() === anioSeleccionado) {
                    pertenece = true;
                }
            }
            
            if (pertenece) {
                const estado = sol.ESTADO;
                const tipo = sol.TIPO_TRABAJO;
                
                // Incrementar total general
                resumenHistorico.totalGeneradas++;
                
                // Conteo por tipo
                if (tipo === 'SODI') {
                    resumenHistorico.totalSODIs++;
                } else {
                    resumenHistorico.totalCEN++;
                }
                
                // Conteo por estado
                if (estado === 'Devuelta') resumenHistorico.totalDevueltas++;
                if (estado === 'No Solicitada') resumenHistorico.totalAnuladas++;
                if (['Por Aprobar', 'En An√°lisis', 'Administrador Gestionando', 'Programada'].includes(estado)) resumenHistorico.totalEnProceso++;
                if (estado === 'Vigente') resumenHistorico.totalVigentes++;
                if (estado === 'Rechazada') resumenHistorico.totalRechazadas++;
                if (estado === 'Extendida') resumenHistorico.totalExtendidas++;
                if (estado === 'Suspendida') resumenHistorico.totalSuspendidas++;
                if (estado === 'Finalizada') resumenHistorico.totalFinalizadas++;
            }
        });
        
        // Generar HTML para dashboard hist√≥rico
        let resumenHistoricoHtml = '';
        
        // Solo mostrar total de solicitudes
        resumenHistoricoHtml += `
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary h-100">
                    <div class="card-body py-2">
                        <h5 class="card-title mb-1">Total Solicitudes
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Generadas" data-content="Cantidad total de solicitudes creadas."></i>
                        </h5>
                        <h2 class="mb-0">${resumenHistorico.totalGeneradas}</h2>
                    </div>
                </div>
            </div>
        `;
        
        // Luego los indicadores por estado
        resumenHistoricoHtml += `
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Solicitudes Generadas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Generadas" data-content="Cantidad total de solicitudes creadas."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalGeneradas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Devueltas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Devueltas" data-content="Solicitudes que han sido devueltas al solicitante para correcci√≥n o ajuste."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalDevueltas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-secondary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Anuladas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Anuladas" data-content="Solicitudes marcadas como 'No Solicitada' o anuladas antes de ser gestionadas."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalAnuladas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total En Proceso
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total En Proceso" data-content="Solicitudes en estados Pendiente, En An√°lisis, Administrador Gestionando"></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalEnProceso}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Vigentes
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Vigentes" data-content="Solicitudes actualmente vigentes seg√∫n su periodo programado."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalVigentes}</h4>
                </div>
            </div>
        </div>

        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-secondary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Extendidas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Extendidas" data-content="Solicitudes cuyo periodo de vigencia ha sido extendido."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalExtendidas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-dark h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Suspendidas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Suspendidas" data-content="Solicitudes que han sido suspendidas temporalmente."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalSuspendidas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-danger h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total No Solicitadas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total No Solicitadas" data-content="Solicitudes que han sido No Solicitada en el flujo de aprobaci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalRechazadas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-danger h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Rechazadas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Rechazadas" data-content="Solicitudes que han sido rechazadas en el flujo de aprobaci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalRechazadas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-secondary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Finalizadas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Finalizadas" data-content="Solicitudes cuyo ciclo de vida ha terminado correctamente."></i>
                    </small>
                    <h4 class="mb-0">${resumenHistorico.totalFinalizadas}</h4>
                </div>
            </div>
        </div>
    `;
        
        // Insertar HTML en el dashboard hist√≥rico
        $('#resumen-solicitante-historico').html(resumenHistoricoHtml);
        // Inicializar popovers para los indicadores
        $('#resumen-solicitante-historico [data-toggle="popover"]').popover();
    };
    
    // Cargar dashboard hist√≥rico inicial
    cargarDashboardHistoricoSolic();
    
    // Configurar comportamiento de los tabs
    $('#dashboard-tabs-solic a').on('click', function (e) {
        e.preventDefault();
        $(this).tab('show');
        
        // Actualizar estilos de los tabs
        $('#dashboard-tabs-solic a').removeClass('bg-white text-dark font-weight-bold').addClass('text-white');
        $(this).removeClass('text-white').addClass('bg-white text-dark font-weight-bold');
    });

    
    // Generar cada fila
    solicitudes.forEach(solicitud => {
        // Determinar funci√≥n de ver seg√∫n el estado
        // Usar funci√≥n unificada para ver solicitudes
        const funcionVer = `verSolicitudSolic(${solicitud.ID_REGISTRO})`;
        
        // Determinar badge de riesgo
        let badgeRiesgo = 'badge-secondary';
        switch(solicitud.RIESGO) {
            case 'Bajo': badgeRiesgo = 'badge-info'; break;
            case 'Medio': badgeRiesgo = 'badge-warning'; break;
            case 'Alto': badgeRiesgo = 'badge-danger'; break;
        }
        
        // Determinar badge de estado
        let badgeEstado = 'badge-secondary';
        switch(solicitud.ESTADO) {
            case 'Pendiente': badgeEstado = 'badge-warning'; break;
            case 'Por Aprobar': badgeEstado = 'badge-info'; break;
            case 'Devuelta': badgeEstado = 'badge-danger'; break;
            case 'En An√°lisis': badgeEstado = 'badge-info'; break;
            case 'Administrador Gestionando': badgeEstado = 'badge-warning text-dark'; break;
            case 'Programada': badgeEstado = 'badge-success'; break;
            case 'Vigente': badgeEstado = 'badge-primary'; break;
            case 'Extendida': badgeEstado = 'badge-secondary'; break;
            case 'Finalizada': badgeEstado = 'badge-dark'; break;
            case 'Rechazada': badgeEstado = 'badge-danger'; break;
        }
        
        // Determinar acciones seg√∫n el estado
        let accionesContenido = '';
        if (['Devuelta'].includes(solicitud.ESTADO)) {
            // Estados editables para el solicitante (Devuelta)
            accionesContenido = `
                <a class="dropdown-item" href="javascript:;" onclick="abrirModalEditarSolic(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-edit mr-2 text-warning"></i> Editar
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="${funcionVer}">
                    <i class="fas fa-eye mr-2 text-primary"></i> Ver
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="clonarSolicitudSolic(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-copy mr-2 text-info"></i> Clonar
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="gestionarSolicitudSolic(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-arrow-circle-right mr-2 text-danger"></i> Gestionar
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="abrirBitacora(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-clipboard-list mr-2 text-success"></i> Bit√°cora
                </a>
            `;
        } else {
            // Estados no editables (solo ver, clonar y bit√°cora)
            accionesContenido = `
                <a class="dropdown-item" href="javascript:;" onclick="${funcionVer}">
                    <i class="fas fa-eye mr-2 text-primary"></i> Ver
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="clonarSolicitudSolic(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-copy mr-2 text-info"></i> Clonar
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="abrirBitacora(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-clipboard-list mr-2 text-success"></i> Bit√°cora
                </a>
            `;
        }

        const acciones = `
            <div class="dropdown d-inline-block">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="accionesMenu${solicitud.ID_REGISTRO}"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="accionesMenu${solicitud.ID_REGISTRO}">
                    ${accionesContenido}
                </div>
            </div>
        `;
        
        // Generar HTML de la fila
        const fila = `
            <tr>
                <td class="text-center">${acciones}</td>
                <td>${solicitud.ID_REGISTRO}</td>
                <td>${solicitud.ID_SOLICITUD}</td>
                <td>${solicitud.TIPO_INTERVENCION}</td>
                <td>${solicitud.INSTALACION_GM}</td>
                <td>${solicitud.DESCRIPCION || ''}</td>
                <td>${solicitud.CONDICIONES || ''}</td>
                <td>${solicitud.EMPRESA_SOLICITANTE}</td>
                <td>${solicitud.EMPRESA_RECEPTORA}</td>
                <td>${solicitud.INICIO_PROGRAMADO}</td>
                <td>${solicitud.FIN_PROGRAMADO}</td>
                <td>${solicitud.APLICA_SODI}</td>
                <td><span class="badge ${badgeEstado}">${solicitud.ESTADO}</span></td>
            </tr>
        `;
        
        tbody.append(fila);
    });
    
    console.log('‚úÖ Solicitudes cargadas exitosamente');
})();

// Encapsular TODO en una IIFE para evitar conflictos de variables
(function() {
    // Variable local para el filtro actual
    let filtroActual = 'proceso';
    
    // Inicializar selectpicker de Instalaci√≥n GM y Estado
    $(function() {
        $('#filtroInstalacionGMSolic').selectpicker();
        $('#filtroEstadoSolic').selectpicker();
        
        // Configurar filtro de estado inicial (por defecto "En Proceso" est√° seleccionado)
        actualizarFiltroEstado('proceso');
    });
    
    // Funci√≥n para limpiar filtros (legacy)
    window.limpiarFiltros = function() {
        $('#zona-filtro select').val('');
        $('#zona-filtro input').val('');
    };
    
    // Funci√≥n para aplicar filtros personalizados
    window.aplicarFiltrosSolic = function() {
        const table = $('#tablaSolicitudesSolicitante').DataTable();
        
        // Obtener valores de filtros
        const filtroInstalacion = $('#filtroInstalacionGMSolic').val(); // ahora puede ser array
        const filtroEquipos = $('#filtroEquiposSolic').val().toLowerCase();
        const filtroTipoInterv = $('#filtroTipoIntervencionSolic').val();
        const filtroEstado = $('#filtroEstadoSolic').val(); // array de estados seleccionados
        const filtroSODI = $('#filtroAplicaSODISolic').val();
        const filtroFechaDesde = $('#filtroFechaDesdeSolic').val();
        const filtroFechaHasta = $('#filtroFechaHastaSolic').val();
        
        // Aplicar b√∫squeda por Instalaci√≥n GM (columna 4) - soporte multi selecci√≥n
        if (Array.isArray(filtroInstalacion) && filtroInstalacion.length > 0 && !filtroInstalacion.includes('')) {
            const pattern = '^(' + filtroInstalacion.join('|') + ')$';
            table.column(4).search(pattern, true, false); // regex = true, smart = false
        } else {
            table.column(4).search('');
        }
        
        // Aplicar b√∫squeda por Equipos (columna 5)
        table.column(5).search(filtroEquipos);
        
        // Aplicar b√∫squeda por Tipo Intervenci√≥n (columna 6)
        table.column(6).search(filtroTipoInterv);
        
        // Aplicar b√∫squeda por Estado (columna 11) - soporte multi selecci√≥n
        if (Array.isArray(filtroEstado) && filtroEstado.length > 0 && !filtroEstado.includes('')) {
            const patternEstado = '(' + filtroEstado.join('|') + ')';
            table.column(11).search(patternEstado, true, false);
        } else {
            table.column(11).search('');
        }
        
        // Aplicar b√∫squeda por Aplica SODI (columna 8)
        table.column(8).search(filtroSODI);
        
        // Redibujar tabla
        table.draw();
        
        console.log('Filtros aplicados:', {filtroInstalacion, filtroEquipos, filtroTipoInterv, filtroEstado, filtroSODI});
    };
    
    // Funci√≥n para limpiar filtros personalizados
    window.limpiarFiltrosSolic = function() {
        // Limpiar inputs
        $('#filtroInstalacionGMSolic').val('');
        $('#filtroEquiposSolic').val('');
        $('#filtroTipoIntervencionSolic').val('');
        $('#filtroEstadoSolic').val('');
        $('#filtroAplicaSODISolic').val('');
        $('#filtroFechaDesdeSolic').val('');
        $('#filtroFechaHastaSolic').val('');
        
        // Reiniciar selectpicker
        $('#filtroInstalacionGMSolic').selectpicker('deselectAll').selectpicker('refresh');
        $('#filtroEstadoSolic').selectpicker('deselectAll').selectpicker('refresh');
        const table = $('#tablaSolicitudesSolicitante').DataTable();
        table.search('').columns().search('').draw();
        
        console.log('Filtros limpiados');
    };
    
    // Funci√≥n para actualizar opciones del filtro de estado
    function actualizarFiltroEstado(tipo) {
        const filtroEstado = $('#filtroEstadoSolic');
        
        // Limpiar opciones actuales
        filtroEstado.empty();
        
        // Agregar opci√≥n "Todos"
        filtroEstado.append('<option value="">Todos</option>');
        
        let estadosAMostrar = [];
        
        if (tipo === 'proceso') {
            estadosAMostrar = estadosEnProceso;
        } else if (tipo === 'finalizadas') {
            estadosAMostrar = estadosFinalizadas;
        } else if (tipo === 'todas') {
            // Mostrar todos los estados
            estadosAMostrar = [...estadosEnProceso, ...estadosFinalizadas];
        }
        
        // Agregar opciones seg√∫n el tipo seleccionado
        estadosAMostrar.forEach(estado => {
            filtroEstado.append(`<option value="${estado}">${estado}</option>`);
        });
        
        // Refrescar el selectpicker
        filtroEstado.selectpicker('refresh');
    }

    // Funci√≥n para filtrar por estado
    window.filtrarPorEstado = function(tipo) {
        console.log('Filtrando por:', tipo);
        filtroActual = tipo;
        
        // Actualizar opciones del filtro de estado
        actualizarFiltroEstado(tipo);
        
        const table = $('#tablaSolicitudesSolicitante').DataTable();
        
        // Aplicar el filtro y redibujar
        table.draw();
    };
    
    // Destruir DataTable si ya existe
    if ($.fn.DataTable.isDataTable('#tablaSolicitudesSolicitante')) {
        $('#tablaSolicitudesSolicitante').DataTable().destroy();
    }
    
    // Limpiar filtros personalizados anteriores
    $.fn.dataTable.ext.search = [];
    
    // Remover el display:none inline de las filas finalizadas para que DataTables las pueda procesar
    $('.solicitud-finalizada').removeAttr('style');
    
    // Estados que se consideran "En Proceso" para Solicitante
    const estadosEnProceso = ['Pendiente', 'Por Aprobar', 'Devuelta', 'En An√°lisis', 'Administrador Gestionando', 'Programada', 'Vigente', 'Extendida', 'Suspendida'];
    
    // Estados que se consideran "Finalizadas"
    const estadosFinalizadas = ['Finalizada', 'No Solicitada', 'Rechazada', 'Anulada'];
    
    // Funci√≥n de filtro personalizada
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            // data[12] es la columna del Estado (√≠ndice 12, la √∫ltima columna)
            const estadoColumna = data[12]; // Contiene el HTML del badge
            
            // Extraer el texto del estado del HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = estadoColumna;
            const estado = tempDiv.textContent.trim();
            
            if (filtroActual === 'proceso') {
                // Mostrar solo estados en proceso
                return estadosEnProceso.includes(estado);
            } else if (filtroActual === 'finalizadas') {
                // Mostrar solo estados finalizadas
                return estadosFinalizadas.includes(estado);
            }
            return true;
        }
    );
    
    $('#tablaSolicitudesSolicitante').DataTable({
        "language": {
            "lengthMenu": "Mostrando _MENU_ solicitudes por p√°gina",
            "zeroRecords": "No se encontraron resultados",
            "info": "Total solicitudes: _TOTAL_. Mostrando p√°gina _PAGE_ de _PAGES_",
            "infoEmpty": "No hay solicitudes disponibles",
            "infoFiltered": "(filtrado de _MAX_ solicitudes totales)",
            "search": "Buscar",
            "paginate": {
                "first": "Primero",
                "last": "√öltimo",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Mostrar todo"]],
        "responsive": true,
        "order": [[9, "asc"]],
        "columnDefs": [
            { "orderable": false, "targets": 0 }
        ]
    });
})();
</script>

<!-- Cargar modales del solicitante -->
<script src="modals/solicitante/modals-loader.js?v=7" defer></script>
