<h2 class="mb-4"><i class="fas fa-user-shield"></i> Administrador - Gesti√≥n de Solicitudes</h2>

<!-- Estilos espec√≠ficos para los tabs -->
<style>
    /* Estilos para los tabs */
    .nav-tabs .nav-link.active {
        background-color: white;
        color: #333;
        font-weight: bold;
        border-bottom-color: white;
    }
    .nav-tabs .nav-link:not(.active) {
        color: white; /* Mejorar contraste */
        font-weight: 600; /* Hacer m√°s visible */
        text-shadow: 0 0 1px rgba(0,0,0,0.3); /* A√±adir sombra para mejor legibilidad */
    }
    .nav-tabs .nav-link:not(.active):hover {
        color: white;
        border-color: rgba(255, 255, 255, 0.5);
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* Estilos para las tarjetas */
    .card-alcance {
        background: linear-gradient(135deg, #1e5799 0%, #207cca 100%);
        border: none;
    }
    
    /* Eliminar bordes de las tarjetas en los dashboards */
    #resumen-administrador-proceso .card,
    #resumen-administrador-historico .card {
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* Eliminar bordes internos en el dashboard hist√≥rico */
    #resumen-administrador-historico .card-body {
        border: none !important;
    }
    
    /* Eliminar borde del contenedor de tabs */
    #dashboard-content {
        border: none !important;
    }
    
    /* Eliminar bordes de los paneles de tabs */
    .tab-pane {
        border: none !important;
    }
    
    /* Mejorar espaciado */
    .card-body {
        padding: 0.75rem;
    }
    
    /* Eliminar bordes del selector */
    #filtroAnioHistorico {
        box-shadow: none;
    }
    
    /* Asegurar que los n√∫meros de los indicadores se vean en blanco */
    .card.text-white h2,
    .card.text-white h4 {
        color: white !important;
    }
    
    /* Asegurar que el dropdown del filtro Estado se vea por encima de los radio buttons */
    /* Reducir z-index de los radio buttons */
    .row.justify-content-end {
        position: relative;
        z-index: 1;
    }
    
    /* Forzar z-index alto para el filtro Estado */
    div[data-id="filtroEstado"] {
        position: relative !important;
        z-index: 1060 !important;
    }
    div[data-id="filtroEstado"] .dropdown-menu {
        z-index: 1061 !important;
        position: absolute !important;
    }
</style>

<!-- Dashboard con tabs para indicadores -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <ul class="nav nav-tabs card-header-tabs" id="dashboard-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active bg-white text-dark font-weight-bold" id="proceso-tab" data-toggle="tab" href="#proceso-content" role="tab" aria-controls="proceso-content" aria-selected="true">
                            <i class="fas fa-tasks"></i> Dashboard En Proceso
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" id="historico-tab" data-toggle="tab" href="#historico-content" role="tab" aria-controls="historico-content" aria-selected="false">
                            <i class="fas fa-history"></i> Dashboard Hist√≥rico
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="dashboard-content">
                    <!-- Tab de Dashboard En Proceso -->
                    <div class="tab-pane fade show active" id="proceso-content" role="tabpanel" aria-labelledby="proceso-tab">
                        <div class="row" id="resumen-administrador-proceso"></div>
                    </div>
                    
                    <!-- Tab de Dashboard Hist√≥rico -->
                    <div class="tab-pane fade" id="historico-content" role="tabpanel" aria-labelledby="historico-tab">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-group d-flex align-items-center border-0">
                                    <label for="filtroAnioHistorico" class="mr-2 mb-0 font-weight-bold">A√±o:</label>
                                    <select class="form-control form-control-sm border-0" id="filtroAnioHistorico" style="width: auto; min-width: 80px; max-width: 120px;" onchange="cargarDashboardHistorico()">
                                        <!-- Las opciones se cargar√°n din√°micamente -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="resumen-administrador-historico"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="btn-group mt-1" id="zona-botonera-filtro" role="group" aria-label="Botonera">
            <button id="showHideFilter" class="btn btn-secondary collapsed" type="button" data-toggle="collapse" data-target="#zona-filtro" aria-expanded="false" aria-controls="zona-filtro">
                <i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i>
                Mostrar filtro
            </button>
            <button id="clearFilter" class="btn btn-outline-dark" type="button" onclick="limpiarFiltros()">
                <i class="fas fa-broom mr-2" aria-hidden="true"></i>
                <span>Limpiar filtro</span>
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card collapse" id="zona-filtro">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtros de B√∫squeda</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>ID Solicitud</label>
                            <input type="text" class="form-control" id="filtroIDSolicitud" placeholder="Buscar por ID...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Tipo de Trabajo</label>
                            <select
                                class="form-control selectpicker"
                                id="filtroTipo"
                                multiple
                                data-actions-box="true"
                                data-live-search="true"
                                data-none-selected-text="Todos los tipos">
                                <option value="">Todos</option>
                                <option value="SDCN">SDCN - Solicitud de Desconexi√≥n Curso Normal</option>
                                <option value="SDCF">SDCF - Solicitud de Desconexi√≥n Curso Forzoso</option>
                                <option value="SICN">SICN - Solicitud de Intervenci√≥n Curso Normal</option>
                                <option value="SICF">SICF - Solicitud de Intervenci√≥n Curso Forzoso</option>
                                <option value="IL">IL - Informe de Limitaci√≥n</option>
                                <option value="MM">MM - Mantenci√≥n Mayor</option>
                                <option value="SODI">SODI - Solicitud de Desconexi√≥n/Intervenci√≥n</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Instalaci√≥n GM</label>
                            <select
                                class="form-control selectpicker"
                                id="filtroInstalacionGM"
                                multiple
                                data-actions-box="true"
                                data-live-search="true"
                                data-none-selected-text="Todas las instalaciones">
                                <option value="">Todas</option>
                                <option value="Santiago Solar">Santiago Solar</option>
                                <option value="Nueva Renca">Nueva Renca</option>
                                <option value="Los Vientos">Los Vientos</option>
                                <option value="Santa Lidia">Santa Lidia</option>
                                <option value="CEME1">CEME1</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Estado</label>
                            <select
                                class="form-control selectpicker"
                                id="filtroEstado"
                                multiple
                                data-actions-box="true"
                                data-live-search="true"
                                data-container="body"
                                data-none-selected-text="Todos los estados">
                                <option value="">Todos</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="Devuelta">Devuelta</option>
                                <option value="En An√°lisis">En An√°lisis</option>
                                <option value="Administrador Gestionando">Administrador Gestionando</option>
                                <option value="Programada">Programada</option>
                                <option value="Vigente">Vigente</option>
                                <option value="Extendida">Extendida</option>
                                <option value="Finalizada">Finalizada</option>
                                <option value="No Solicitada">No Solicitada</option>
                                <option value="Rechazada">Rechazada</option>
                                <option value="Suspendida">Suspendida</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                                        <div class="col-md-3">
                        <div class="form-group">
                            <label>Empresa Solicitante</label>
                            <select class="form-control" id="filtroEmpresaSolicitante">
                                <option value="">Todas</option>
                                <option value="CDC">CDC</option>
                                <option value="GM">GM</option>
                                <option value="Transelec Norte">Transelec Norte</option>
                                <option value="Transelec Sur">Transelec Sur</option>
                                <option value="Chilquinta">Chilquinta</option>
                                <option value="Saesa">Saesa</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Empresa Receptora</label>
                            <select class="form-control" id="filtroEmpresaReceptora">
                                <option value="">Todas</option>
                                <option value="CDC">CDC</option>
                                <option value="GM">GM</option>
                                <option value="Transelec Norte">Transelec Norte</option>
                                <option value="Transelec Sur">Transelec Sur</option>
                                <option value="Chilquinta">Chilquinta</option>
                                <option value="Saesa">Saesa</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Programada Inicio Desde</label>
                            <input type="date" class="form-control" id="filtroFechaDesde">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Fecha Programada Inicio Hasta</label>
                            <input type="date" class="form-control" id="filtroFechaHasta">
                        </div>
                    </div>
                </div>
                <div class="row">
                                        <div class="col-md-3">
                        <div class="form-group">
                            <label>Aplica SODI</label>
                            <select class="form-control" id="filtroAplicaSODI">
                                <option value="">Todos</option>
                                <option value="S√≠">S√≠</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="btns-accion-filtro d-flex align-items-center">
                    <a href="javascript:;" class="btn-filtrar text-decoration-none mr-3" onclick="aplicarFiltrosAdmin()">
                        <i class="fas fa-filter"></i> Filtrar
                    </a>
                    <a href="javascript:;" class="btn-limpiar text-decoration-none" onclick="limpiarFiltrosAdmin()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 align-items-center">
    <div class="col-lg-6">
        <div class="botonera d-flex align-items-center">
            <a class="btn btn-customized" href="javascript:;" role="button" onclick="abrirModalNuevaSolicitudAdmin()" id="btn-newDoc">
                <i class="fa fa-plus"></i> Nueva Solicitud
            </a>
            <a class="btn btn-success ml-2" href="javascript:;" role="button" id="btn-descargar-excel-admin">
                <i class="fas fa-file-excel"></i> Descargar Excel Vinculado
            </a>
        </div>
    </div>
    <div class="col-lg-6 col-md-6 col-sm-12">
        <div class="row justify-content-end">
            <div class="form-group col-lg-3 col-md-3 col-sm-3 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" checked="" id="cbxEnProceso" autocomplete="off" onchange="filtrarPorEstado('proceso')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="En Proceso" autocomplete="off">
                </div>
            </div>
            <div class="form-group col-lg-3 col-md-3 col-sm-3 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" id="cbxFinalizadas" autocomplete="off" onchange="filtrarPorEstado('finalizadas')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="Finalizadas" autocomplete="off">
                </div>
            </div>
            <div class="form-group col-lg-3 col-md-3 col-sm-3 mb-0">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <div class="input-group-text">
                            <input class="cbxFilter" type="radio" aria-label="" name="flexRadioDefault" id="cbxTodas" autocomplete="off" onchange="filtrarPorEstado('todas')">
                        </div>
                    </div>
                    <input type="text" class="form-control" disabled="" aria-label="" value="Todas" autocomplete="off">
                </div>
            </div>            
        </div>
    </div>
                
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="table-solicitudes" class="table table-sm table-hover table-bordered w-100">
                        <thead>
                            <tr class="table-group">
                                <th class="text-center">Acciones</th>
                                <th>ID Registro</th>
                                <th>ID CEN</th>
                                <th>Tipo de intervenci√≥n</th>
                                <th>Instalaci√≥n GM</th>
                                <th>Descripci√≥n del trabajo</th>
                                <th>Condiciones requeridas</th>
                                <th>Empresa solicitante</th>
                                <th>Empresa receptora</th>
                                <th>Fecha programada de inicio</th>
                                <th>Fecha programada de fin</th>
                                <th>Aplica SODI</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Solicitud 1 - Pendiente -->
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// Cambiar texto del bot√≥n al colapsar/expandir
$('#zona-filtro').on('show.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Ocultar filtro');
});

$('#zona-filtro').on('hide.bs.collapse', function () {
    $('#showHideFilter').html('<i class="fa fa-filter mr-2 text-white" aria-hidden="true"></i> Mostrar filtro');
});

// ============================================
// CARGAR DATOS DIN√ÅMICAMENTE DESDE solicitudesData
// ============================================
(function() {
    console.log('üîÑ Cargando solicitudes del administrador...');
    
    // Verificar que solicitudesData existe
    if (typeof solicitudesData === 'undefined') {
        console.error('‚ùå solicitudesData no est√° definido');
        return;
    }
    
    // El administrador puede ver TODAS las solicitudes
    const solicitudes = solicitudesData;
    console.log(`üìä Encontradas ${solicitudes.length} solicitudes totales`);
    
    const tbody = $('#table-solicitudes tbody');
    tbody.empty(); // Limpiar tabla

    // Calcular resumen por tipo/estado
    const resumen = {
        totalSolicitudesGeneradas: 0, // sin SODI
        totalDevueltas: 0,
        totalAnuladas: 0,
        totalEnProceso: 0,
        totalVigentes: 0,
        totalRechazado: 0,
        totalExtendida: 0,
        totalSuspendida: 0,
        totalFinalizadas: 0
    };

    solicitudes.forEach(sol => {
        const estado = sol.ESTADO;
        const tipo = sol.TIPO;

        // Total solicitudes generadas descartando SODI
        if (tipo !== 'SODI') {
            resumen.totalSolicitudesGeneradas++;
        }

        if (estado === 'Devuelta') resumen.totalDevueltas++;
        if (estado === 'No Solicitada') resumen.totalAnuladas++;
        if (['En An√°lisis', 'Administrador Gestionando', 'Programada'].includes(estado)) resumen.totalEnProceso++;
        if (estado === 'Vigente') resumen.totalVigentes++;
        if (estado === 'Rechazada') resumen.totalRechazado++;
        if (estado === 'Extendida') resumen.totalExtendida++;
        if (estado === 'Suspendida') resumen.totalSuspendida++;
        if (estado === 'Finalizada') resumen.totalFinalizadas++;
    });

    // Pintar tarjetas de resumen
    let resumenHtml = '';
    resumenHtml += `
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Solicitudes Generadas</small>
                    <h4 class="mb-0">${resumen.totalSolicitudesGeneradas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Devueltas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Devueltas - A√±o en curso" data-content="Solicitudes que han sido devueltas en el flujo de aprobaci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalDevueltas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-secondary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Anuladas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Anuladas - A√±o en curso" data-content="Solicitudes que han sido anuladas en el flujo de aprobaci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalAnuladas}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total En Proceso
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total En Proceso - A√±o en curso" data-content="Solicitudes que se encuentran en proceso de aprobaci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalEnProceso}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Vigentes
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Vigentes - A√±o en curso" data-content="Solicitudes actualmente vigentes seg√∫n su periodo programado."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalVigentes}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-danger h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Rechazado
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Rechazado - A√±o en curso" data-content="Solicitudes que han sido rechazadas en el flujo de aprobaci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalRechazado}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-secondary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Extendida
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Extendida - A√±o en curso" data-content="Solicitudes cuyo periodo de vigencia ha sido extendido."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalExtendida}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-dark h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Suspendida
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Suspendida - A√±o en curso" data-content="Solicitudes suspendidas temporalmente en su ejecuci√≥n."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalSuspendida}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-secondary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Total Finalizadas
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Finalizadas - A√±o en curso" data-content="Solicitudes cuyo ciclo de vida ha finalizado correctamente."></i>
                    </small>
                    <h4 class="mb-0">${resumen.totalFinalizadas}</h4>
                </div>
            </div>
        </div>
    `;

    $('#resumen-administrador').html(resumenHtml);
    // Inicializar popovers para los indicadores
    $('#resumen-administrador [data-toggle="popover"]').popover();
    
    // ===============================
    // Calcular indicadores para ambos dashboards
    // ===============================
    
    // Obtener fecha actual y calcular fecha en 30 d√≠as
    const ahora = new Date();
    const en30Dias = new Date();
    en30Dias.setDate(ahora.getDate() + 30);
    const anioActual = ahora.getFullYear();
    
    // Extraer a√±os √∫nicos de las solicitudes para el selector
    const aniosDisponibles = new Set();
    solicitudes.forEach(sol => {
        if (sol.CREADO) {
            const fechaCreacion = new Date(sol.CREADO);
            if (!isNaN(fechaCreacion.getTime())) {
                aniosDisponibles.add(fechaCreacion.getFullYear());
            }
        }
    });
    
    // Asegurar que siempre est√©n disponibles al menos los a√±os 2023, 2024 y 2025
    aniosDisponibles.add(2023);
    aniosDisponibles.add(2024);
    aniosDisponibles.add(2025);
    
    // Si no hay a√±os disponibles en los datos, agregar a√±os de ejemplo
    if (aniosDisponibles.size < 5) {
        // A√±adir a√±o actual y 4 a√±os anteriores como ejemplo
        aniosDisponibles.add(anioActual);
        for (let i = 1; i <= 4; i++) {
            aniosDisponibles.add(anioActual - i);
        }
    }
    
    // Ordenar a√±os de mayor a menor
    const aniosOrdenados = Array.from(aniosDisponibles).sort((a, b) => b - a);
    
    // Poblar selector de a√±os
    const selectorAnio = $('#filtroAnioHistorico');
    selectorAnio.empty();
    aniosOrdenados.forEach(anio => {
        selectorAnio.append(`<option value="${anio}"${anio === anioActual ? ' selected' : ''}>${anio}</option>`);
    });
    
    // ===============================
    // Dashboard En Proceso
    // ===============================
    
    // Indicadores para solicitudes en proceso
    const resumenProceso = {
        totalEnAnalisis: 0,
        totalAdminGestionando: 0,
        totalProgramada: 0,
        totalVigentes: 0,
        totalExtendida: 0,
        sodiProgramadas: 0,
        intervencionesProgramadas: 0,
        desconexionesProgramadas: 0
    };

    solicitudes.forEach(sol => {
        const estado = sol.ESTADO;
        const tipo = sol.TIPO;
        
        // Conteo por estados en proceso
        if (estado === 'En An√°lisis') resumenProceso.totalEnAnalisis++;
        if (estado === 'Administrador Gestionando') resumenProceso.totalAdminGestionando++;
        if (estado === 'Programada') resumenProceso.totalProgramada++;
        if (estado === 'Vigente') resumenProceso.totalVigentes++;
        if (estado === 'Extendida') resumenProceso.totalExtendida++;
        
        // Conteo para indicadores de pr√≥ximos 30 d√≠as
        if (estado === 'Programada' && sol.INICIO_PROGRAMADO) {
            const fechaInicio = new Date(sol.INICIO_PROGRAMADO);
            if (!isNaN(fechaInicio.getTime()) && fechaInicio >= ahora && fechaInicio <= en30Dias) {
                // Clasificar seg√∫n tipo
                if (tipo === 'SODI') {
                    resumenProceso.sodiProgramadas++;
                } else if (['SICN', 'SICF'].includes(tipo)) {
                    resumenProceso.intervencionesProgramadas++;
                } else if (['SDCN', 'SDCF'].includes(tipo)) {
                    resumenProceso.desconexionesProgramadas++;
                }
            }
        }
    });

    // Generar HTML para dashboard en proceso
    let resumenProcesoHtml = '';
    
    // Primero los indicadores de pr√≥ximos 30 d√≠as
    resumenProcesoHtml += `
        <div class="col-md-4 mb-3">
            <div class="card card-alcance text-white">
                <div class="card-body py-2">
                    <h5 class="card-title mb-1"><i class="fas fa-bolt"></i> SODI Programadas (30 d√≠as)
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="SODI Programadas (30 d√≠as)" data-content="Solicitudes de tipo SODI en estado Programada cuyo inicio est√° dentro de los pr√≥ximos 30 d√≠as."></i>
                    </h5>
                    <h2 class="mb-0">${resumenProceso.sodiProgramadas}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card card-alcance text-white">
                <div class="card-body py-2">
                    <h5 class="card-title mb-1"><i class="fas fa-tools"></i> Intervenciones Programadas (30 d√≠as)
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Intervenciones Programadas (30 d√≠as)" data-content="Solicitudes de tipo SICN/SICF en estado Programada cuyo inicio est√° dentro de los pr√≥ximos 30 d√≠as."></i>
                    </h5>
                    <h2 class="mb-0">${resumenProceso.intervencionesProgramadas}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card card-alcance text-white">
                <div class="card-body py-2">
                    <h5 class="card-title mb-1"><i class="fas fa-plug"></i> Desconexiones Programadas (30 d√≠as)
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Desconexiones Programadas (30 d√≠as)" data-content="Solicitudes de tipo SDCN/SDCF en estado Programada cuyo inicio est√° dentro de los pr√≥ximos 30 d√≠as."></i>
                    </h5>
                    <h2 class="mb-0">${resumenProceso.desconexionesProgramadas}</h2>
                </div>
            </div>
        </div>
    `;
    
    // Luego los indicadores de estados en proceso
    resumenProcesoHtml += `
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-info h-100">
                <div class="card-body py-2">
                    <small class="d-block">En An√°lisis
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="En An√°lisis" data-content="Solicitudes que se encuentran en estado de an√°lisis."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalEnAnalisis}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body py-2">
                    <small class="d-block">Admin. Gestionando
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Administrador Gestionando" data-content="Solicitudes que est√°n siendo gestionadas por un administrador."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalAdminGestionando}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body py-2">
                    <small class="d-block">Programada
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Programada" data-content="Solicitudes que han sido programadas pero a√∫n no est√°n vigentes."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalProgramada}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Vigente
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Vigente" data-content="Solicitudes actualmente vigentes seg√∫n su periodo programado."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalVigentes}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 col-lg-2 mb-3">
            <div class="card text-white bg-secondary h-100">
                <div class="card-body py-2">
                    <small class="d-block">Extendida
                        <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Extendida" data-content="Solicitudes cuyo periodo de vigencia ha sido extendido."></i>
                    </small>
                    <h4 class="mb-0">${resumenProceso.totalExtendida}</h4>
                </div>
            </div>
        </div>
    `;
    
    // Insertar HTML en el dashboard de proceso
    $('#resumen-administrador-proceso').html(resumenProcesoHtml);
    // Inicializar popovers para los indicadores
    $('#resumen-administrador-proceso [data-toggle="popover"]').popover();
    
    // ===============================
    // Funci√≥n para cargar Dashboard Hist√≥rico
    // ===============================
    window.cargarDashboardHistorico = function() {
        const anioSeleccionado = parseInt($('#filtroAnioHistorico').val());
        
        // Indicadores para solicitudes hist√≥ricas
        const resumenHistorico = {
            totalGeneradas: 0,
            totalSODIs: 0,
            totalCEN: 0,
            totalDevueltas: 0,
            totalAnuladas: 0,
            totalEnProceso: 0,
            totalVigentes: 0,
            totalRechazadas: 0,
            totalExtendidas: 0,
            totalSuspendidas: 0,
            totalFinalizadas: 0
        };
        
        solicitudes.forEach(sol => {
            // Verificar si la solicitud pertenece al a√±o seleccionado
            let pertenece = false;
            if (sol.CREADO) {
                const fechaCreacion = new Date(sol.CREADO);
                if (!isNaN(fechaCreacion.getTime()) && fechaCreacion.getFullYear() === anioSeleccionado) {
                    pertenece = true;
                }
            }
            
            if (pertenece) {
                const estado = sol.ESTADO;
                const tipo = sol.TIPO;
                
                // Incrementar total general
                resumenHistorico.totalGeneradas++;
                
                // Conteo por tipo
                if (tipo === 'SODI') {
                    resumenHistorico.totalSODIs++;
                } else {
                    resumenHistorico.totalCEN++;
                }
                
                // Conteo por estado
                if (estado === 'Devuelta') resumenHistorico.totalDevueltas++;
                if (estado === 'No Solicitada') resumenHistorico.totalAnuladas++;
                if (['En An√°lisis', 'Administrador Gestionando', 'Programada'].includes(estado)) resumenHistorico.totalEnProceso++;
                if (estado === 'Vigente') resumenHistorico.totalVigentes++;
                if (estado === 'Rechazada') resumenHistorico.totalRechazadas++;
                if (estado === 'Extendida') resumenHistorico.totalExtendidas++;
                if (estado === 'Suspendida') resumenHistorico.totalSuspendidas++;
                if (estado === 'Finalizada') resumenHistorico.totalFinalizadas++;
            }
        });
        
        // Generar HTML para dashboard hist√≥rico
        let resumenHistoricoHtml = '';
        
        // Primero los totales por tipo (en una fila con 3 columnas de igual tama√±o)
        resumenHistoricoHtml += `
            <div class="col-md-4 mb-3">
                <div class="card text-white bg-primary h-100">
                    <div class="card-body py-2">
                        <h5 class="card-title mb-1">Total Solicitudes
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Solicitudes ${anioSeleccionado}" data-content="Total de solicitudes generadas en el a√±o ${anioSeleccionado}."></i>
                        </h5>
                        <h2 class="mb-0">${resumenHistorico.totalGeneradas}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-white bg-danger h-100">
                    <div class="card-body py-2">
                        <h5 class="card-title mb-1">Total SODIs
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total SODIs ${anioSeleccionado}" data-content="Total de solicitudes tipo SODI generadas en ${anioSeleccionado}."></i>
                        </h5>
                        <h2 class="mb-0">${resumenHistorico.totalSODIs}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card text-white bg-info h-100">
                    <div class="card-body py-2">
                        <h5 class="card-title mb-1">Total CEN
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total CEN ${anioSeleccionado}" data-content="Total de solicitudes no SODI (CEN) generadas en ${anioSeleccionado}."></i>
                        </h5>
                        <h2 class="mb-0">${resumenHistorico.totalCEN}</h2>
                    </div>
                </div>
            </div>
        `;
        
        // Luego los indicadores por estado
        resumenHistoricoHtml += `
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-warning h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total Devueltas
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Devueltas - ${anioSeleccionado}" data-content="Solicitudes que han sido devueltas en el flujo de aprobaci√≥n."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalDevueltas}</h4>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-secondary h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total Anuladas
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Anuladas - ${anioSeleccionado}" data-content="Solicitudes que han sido anuladas en el flujo de aprobaci√≥n."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalAnuladas}</h4>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-info h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total En Proceso
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total En Proceso - ${anioSeleccionado}" data-content="Solicitudes en estados En An√°lisis, Administrador Gestionando o Programada."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalEnProceso}</h4>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-success h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total Vigentes
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Vigentes - ${anioSeleccionado}" data-content="Solicitudes actualmente vigentes seg√∫n su periodo programado."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalVigentes}</h4>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-danger h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total Rechazadas
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Rechazadas - ${anioSeleccionado}" data-content="Solicitudes que han sido rechazadas en el flujo de aprobaci√≥n."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalRechazadas}</h4>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-secondary h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total Extendidas
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Extendidas - ${anioSeleccionado}" data-content="Solicitudes cuyo periodo de vigencia ha sido extendido."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalExtendidas}</h4>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-dark h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total Suspendidas
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Suspendidas - ${anioSeleccionado}" data-content="Solicitudes suspendidas temporalmente en su ejecuci√≥n."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalSuspendidas}</h4>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="card text-white bg-secondary h-100">
                    <div class="card-body py-2">
                        <small class="d-block">Total Finalizadas
                            <i class="fas fa-info-circle ml-1" data-toggle="popover" data-placement="top" title="Total Finalizadas - ${anioSeleccionado}" data-content="Solicitudes cuyo ciclo de vida ha finalizado correctamente."></i>
                        </small>
                        <h4 class="mb-0">${resumenHistorico.totalFinalizadas}</h4>
                    </div>
                </div>
            </div>
        `;
        
        // Insertar HTML en el dashboard hist√≥rico
        $('#resumen-administrador-historico').html(resumenHistoricoHtml);
        // Inicializar popovers para los indicadores
        $('#resumen-administrador-historico [data-toggle="popover"]').popover();
    };
    
    // Cargar dashboard hist√≥rico inicial
    cargarDashboardHistorico();
    
    // Configurar comportamiento de los tabs
    $('#dashboard-tabs a').on('click', function (e) {
        e.preventDefault();
        $(this).tab('show');
        
        // Actualizar estilos de los tabs
        $('#dashboard-tabs a').removeClass('bg-white text-dark font-weight-bold').addClass('text-white');
        $(this).removeClass('text-white').addClass('bg-white text-dark font-weight-bold');
    });
    
    // Generar cada fila
    solicitudes.forEach(solicitud => {
        // Determinar funci√≥n de ver seg√∫n el estado
        let funcionVer = '';
        switch(solicitud.ESTADO) {
            case 'Pendiente':
                funcionVer = `verSolicitudPendienteAdmin(${solicitud.ID_REGISTRO})`;
                break;
            case 'Devuelta':
                funcionVer = `verSolicitudDevueltaAdmin(${solicitud.ID_REGISTRO})`;
                break;
            case 'En An√°lisis':
                funcionVer = `verSolicitudEnAnalisisAdmin(${solicitud.ID_REGISTRO})`;
                break;
            case 'Administrador Gestionando':
                funcionVer = `verSolicitudAdminGestionandoAdmin(${solicitud.ID_REGISTRO})`;
                break;
            case 'Programada':
                funcionVer = `verSolicitudProgramadaAdmin(${solicitud.ID_REGISTRO})`;
                break;
            case 'Vigente':
                funcionVer = `verSolicitudVigenteAdmin(${solicitud.ID_REGISTRO})`;
                break;
            case 'Extendida':
                funcionVer = `verSolicitudExtendidaAdmin(${solicitud.ID_REGISTRO})`;
                break;
            case 'Finalizada':
                funcionVer = `verSolicitudFinalizada(${solicitud.ID_REGISTRO})`;
                break;
            case 'Rechazada':
                funcionVer = `verSolicitudRechazada(${solicitud.ID_REGISTRO})`;
                break;
            case 'Suspendida':
                funcionVer = `verSolicitudSuspendida(${solicitud.ID_REGISTRO})`;
                break;
            case 'No Solicitada':
                funcionVer = `verSolicitudNoSolicitada(${solicitud.ID_REGISTRO})`;
                break;
            default:
                funcionVer = `verSolicitudPendienteAdmin(${solicitud.ID_REGISTRO})`;
        }
        
        // Determinar badge de tipo
        let badgeTipo = 'badge-secondary';
        switch(solicitud.TIPO) {
            case 'SDCN': badgeTipo = 'badge-primary'; break;
            case 'SICF': badgeTipo = 'badge-success'; break;
            case 'SODI': badgeTipo = 'badge-danger'; break;
            case 'IL': badgeTipo = 'badge-warning'; break;
            case 'MM': badgeTipo = 'badge-info'; break;
            case 'SDCF': badgeTipo = 'badge-dark'; break;
            case 'SICN': badgeTipo = 'badge-secondary'; break;
        }
        
        // Determinar badge de estado
        let badgeEstado = 'badge-secondary';
        let claseFinalizad = '';
        switch(solicitud.ESTADO) {
            case 'Pendiente': badgeEstado = 'badge-warning'; break;
            case 'Devuelta': badgeEstado = 'badge-danger'; break;
            case 'En An√°lisis': badgeEstado = 'badge-info'; break;
            case 'Administrador Gestionando': badgeEstado = 'badge-warning text-dark'; break;
            case 'Programada': badgeEstado = 'badge-success'; break;
            case 'Vigente': badgeEstado = 'badge-primary'; break;
            case 'Extendida': badgeEstado = 'badge-secondary'; break;
            case 'Finalizada': 
                badgeEstado = 'badge-secondary'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
            case 'Rechazada': 
                badgeEstado = 'badge-danger'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
            case 'Suspendida': 
                badgeEstado = 'badge-dark'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
            case 'No Solicitada': 
                badgeEstado = 'badge-secondary'; 
                claseFinalizad = 'solicitud-finalizada';
                break;
        }
        
        // Determinar acciones seg√∫n el estado
        let accionesContenido = '';
        if (['Pendiente', 'En An√°lisis', 'Administrador Gestionando'].includes(solicitud.ESTADO)) {
            // Estados gestionables (sin Devuelta)
            // Bot√≥n Editar: Para "Administrador Gestionando" y "En An√°lisis"
            const botonEditar = ['Administrador Gestionando', 'En An√°lisis'].includes(solicitud.ESTADO)
                ? `<a class="dropdown-item" href="javascript:;" onclick="editarSolicitudAdmin(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-edit mr-2 text-warning"></i> Editar
                </a>` 
                : '';
            
            accionesContenido = `
                ${botonEditar}
                <a class="dropdown-item" href="javascript:;" onclick="${funcionVer}">
                    <i class="fas fa-eye mr-2 text-primary"></i> Ver
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="clonarSolicitudAdmin(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-copy mr-2 text-info"></i> Clonar
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="gestionarSolicitudAdmin(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-arrow-circle-right mr-2 text-danger"></i> Gestionar
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="abrirBitacora(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-clipboard-list mr-2 text-success"></i> Bit√°cora
                </a>
            `;
        } else {
            // Estados no gestionables (Devuelta, Programada, Vigente, Extendida, Finalizadas)
            accionesContenido = `
                <a class="dropdown-item" href="javascript:;" onclick="${funcionVer}">
                    <i class="fas fa-eye mr-2 text-primary"></i> Ver
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="clonarSolicitudAdmin(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-copy mr-2 text-info"></i> Clonar
                </a>
                <a class="dropdown-item" href="javascript:;" onclick="abrirBitacora(${solicitud.ID_REGISTRO})">
                    <i class="fas fa-clipboard-list mr-2 text-success"></i> Bit√°cora
                </a>
            `;
        }

        const acciones = `
            <div class="dropdown d-inline-block">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="accionesMenuAdmin${solicitud.ID_REGISTRO}"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="accionesMenuAdmin${solicitud.ID_REGISTRO}">
                    ${accionesContenido}
                </div>
            </div>
        `;
        
        // Generar HTML de la fila
        const fila = `
            <tr class="${claseFinalizad}">
                <td class="text-center">${acciones}</td>
                <td>${solicitud.ID_REGISTRO}</td>
                <td>${solicitud.ID_SOLICITUD}</td>
                <td>${solicitud.TIPO_INTERVENCION || solicitud.TIPO}</td>
                <td>${solicitud.INSTALACION_GM}</td>
                <td>${solicitud.DESCRIPCION || ''}</td>
                <td>${solicitud.CONDICIONES || ''}</td>
                <td>${solicitud.EMPRESA_SOLICITANTE}</td>
                <td>${solicitud.EMPRESA_RECEPTORA}</td>
                <td>${solicitud.INICIO_PROGRAMADO}</td>
                <td>${solicitud.FIN_PROGRAMADO}</td>
                <td>${solicitud.APLICA_SODI}</td>
                <td><span class="badge ${badgeEstado}">${solicitud.ESTADO}</span></td>
            </tr>
        `;
        
        tbody.append(fila);
    });

    console.log('‚úÖ Solicitudes cargadas exitosamente');
})();


<!-- Encapsular TODO en una IIFE para evitar conflictos de variables -->
(function() {
    // Variable local para el filtro actual
    let filtroActual = 'proceso';
    
    // Fechas m√≠nimas y m√°ximas (√∫ltimos 24 meses)
    const hoy = new Date();
    const haceDosAnios = new Date(hoy.getTime());
    haceDosAnios.setFullYear(hoy.getFullYear() - 2);
    
    function formatearFecha(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    const fechaMax = formatearFecha(hoy);
    const fechaMin = formatearFecha(haceDosAnios);
    
    // Inicializar selectpicker de Instalaci√≥n GM, Tipo de Trabajo y Estado
    $(function() {
        $('#filtroInstalacionGM').selectpicker();
        $('#filtroTipo').selectpicker();
        $('#filtroEstado').selectpicker();
        
        // Restringir siempre el rango de fechas a los √∫ltimos 2 a√±os
        $('#filtroFechaDesde, #filtroFechaHasta').attr('min', fechaMin).attr('max', fechaMax);
    });
    
    // Funci√≥n para limpiar filtros (legacy)
    window.limpiarFiltros = function() {
        $('#zona-filtro select').val('');
        $('#zona-filtro input').val('');
    };
    
    // Funci√≥n para aplicar filtros personalizados
    window.aplicarFiltrosAdmin = function() {
        const table = $('#table-solicitudes').DataTable();
        
        // Obtener valores de filtros
        const filtroID = $('#filtroIDSolicitud').val().toLowerCase();
        const filtroTipo = $('#filtroTipo').val(); // array de tipos seleccionados
        const filtroInstalacion = $('#filtroInstalacionGM').val(); // puede ser array
        const filtroEmpSol = $('#filtroEmpresaSolicitante').val();
        const filtroEmpRec = $('#filtroEmpresaReceptora').val();
        const filtroSODI = $('#filtroAplicaSODI').val();
        const filtroFechaDesde = $('#filtroFechaDesde').val();
        const filtroFechaHasta = $('#filtroFechaHasta').val();
        const filtroEstado = $('#filtroEstado').val(); // array de estados seleccionados
        
        // Aplicar b√∫squeda por ID
        table.column(2).search(filtroID);
        
        // Aplicar b√∫squeda por Tipo de Trabajo (multi-selecci√≥n)
        if (Array.isArray(filtroTipo) && filtroTipo.length > 0 && !filtroTipo.includes('')) {
            const patternTipo = '^(' + filtroTipo.join('|') + ')$';
            table.column(3).search(patternTipo, true, false);
        } else {
            table.column(3).search('');
        }
        
        // Aplicar b√∫squeda por Instalaci√≥n GM (multi-selecci√≥n)
        if (Array.isArray(filtroInstalacion) && filtroInstalacion.length > 0 && !filtroInstalacion.includes('')) {
            const pattern = '^(' + filtroInstalacion.join('|') + ')$';
            table.column(6).search(pattern, true, false);
        } else {
            table.column(6).search('');
        }
        
        // Aplicar b√∫squeda por Empresa Solicitante
        table.column(9).search(filtroEmpSol);
        
        // Aplicar b√∫squeda por Empresa Receptora
        table.column(10).search(filtroEmpRec);
        
        // Aplicar b√∫squeda por Aplica SODI
        table.column(11).search(filtroSODI);
        
        // Aplicar b√∫squeda por Estado (multi-selecci√≥n)
        if (Array.isArray(filtroEstado) && filtroEstado.length > 0 && !filtroEstado.includes('')) {
            const patternEstado = '(' + filtroEstado.join('|') + ')';
            table.column(12).search(patternEstado, true, false);
        } else {
            table.column(12).search('');
        }
        
        // Redibujar tabla
        table.draw();
        
        console.log('Filtros aplicados:', {filtroID, filtroTipo, filtroInstalacion, filtroEmpSol, filtroEmpRec, filtroSODI, filtroEstado, filtroFechaDesde, filtroFechaHasta});
    };
    
    // Funci√≥n para limpiar filtros personalizados
    window.limpiarFiltrosAdmin = function() {
        // Limpiar inputs
        $('#filtroIDSolicitud').val('');
        $('#filtroTipo').val('');
        $('#filtroInstalacionGM').val('');
        $('#filtroEmpresaSolicitante').val('');
        $('#filtroEmpresaReceptora').val('');
        $('#filtroAplicaSODI').val('');
        $('#filtroFechaDesde').val('');
        $('#filtroFechaHasta').val('');
        $('#filtroEstado').val('');
        
        // Reiniciar selectpicker
        $('#filtroInstalacionGM').selectpicker('deselectAll').selectpicker('refresh');
        $('#filtroTipo').selectpicker('deselectAll').selectpicker('refresh');
        $('#filtroEstado').selectpicker('deselectAll').selectpicker('refresh');
        
        // Limpiar b√∫squedas de DataTable
        const table = $('#table-solicitudes').DataTable();
        table.search('').columns().search('').draw();
        
        console.log('Filtros limpiados');
    };
    
    // Funci√≥n para filtrar por estado
    window.filtrarPorEstado = function(tipo) {
        console.log('Filtrando por:', tipo);
        filtroActual = tipo;
        
        // Ajustar rango de fechas seg√∫n el radio seleccionado
        if (tipo === 'proceso') {
            // En Proceso: no aplicar rango por defecto, solo restricciones de 2 a√±os
            $('#filtroFechaDesde').val('');
            $('#filtroFechaHasta').val('');
        } else if (tipo === 'finalizadas' || tipo === 'todas') {
            // Finalizadas o Todas: mostrar por defecto los √∫ltimos 24 meses
            $('#filtroFechaDesde').val(fechaMin);
            $('#filtroFechaHasta').val(fechaMax);
        }
        
        const table = $('#table-solicitudes').DataTable();
        
        // Aplicar el filtro y redibujar
        table.draw();
    };
    
    // Destruir DataTable si ya existe
    if ($.fn.DataTable.isDataTable('#table-solicitudes')) {
        $('#table-solicitudes').DataTable().destroy();
    }
    
    // Limpiar filtros personalizados anteriores
    $.fn.dataTable.ext.search = [];
    
    // Remover el display:none inline de las filas finalizadas para que DataTables las pueda procesar
    $('.solicitud-finalizada').removeAttr('style');
    
    // Estados que se consideran "En Proceso" para Administrador
    const estadosEnProceso = ['Pendiente', 'Devuelta', 'En An√°lisis', 'Administrador Gestionando', 'Programada', 'Vigente', 'Extendida'];
    
    // Estados que se consideran "Finalizadas"
    const estadosFinalizadas = ['Finalizada', 'No Solicitada', 'Rechazada', 'Suspendida'];
    
    // Funci√≥n de filtro personalizada
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            // data[12] es la columna del Estado (√≠ndice 12, la √∫ltima columna)
            const estadoColumna = data[12]; // Contiene el HTML del badge
            
            // Extraer el texto del estado del HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = estadoColumna;
            const estado = tempDiv.textContent.trim();
            
            if (filtroActual === 'proceso') {
                // Mostrar solo estados en proceso
                return estadosEnProceso.includes(estado);
            } else if (filtroActual === 'finalizadas') {
                // Mostrar solo estados finalizadas
                return estadosFinalizadas.includes(estado);
            }
            return true;
        }
    );
    
    $('#table-solicitudes').DataTable({
        "language": {
            "lengthMenu": "Mostrando _MENU_ solicitudes por p√°gina",
            "zeroRecords": "No se encontraron resultados",
            "info": "Total solicitudes: _TOTAL_. Mostrando p√°gina _PAGE_ de _PAGES_",
            "infoEmpty": "No hay solicitudes disponibles",
            "infoFiltered": "(filtrado de _MAX_ solicitudes totales)",
            "search": "Buscar",
            "paginate": {
                "first": "Primero",
                "last": "√öltimo",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Mostrar todo"]],
        "responsive": true,
        "order": [[9, "asc"]],
        "columnDefs": [
            { "orderable": false, "targets": 0 }
        ]
    });
})();
</script>

<!-- Cargar modales del administrador -->
<script src="modals/administrador/modals-loader.js?v=12" defer></script>
